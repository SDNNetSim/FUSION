# Shared Context: Legacy Request Dictionary Structure

**Purpose**: Document the current request dictionary structure for P1.2 tasks
**Source**: Extracted from `fusion/core/request.py` and usage across the codebase

---

## Current Request Dictionary Format

Requests are generated by `generate_simulation_requests()` in `fusion/core/request.py` (lines 110-154).

### Request Dictionary Fields

```python
request_dict = {
    # Identity (set at creation, never changes)
    "req_id": int,              # Unique request identifier
    "source": str,              # Source node ID (string, e.g., "0", "NYC")
    "destination": str,         # Destination node ID (string)

    # Timing
    "arrive": float,            # Arrival time (simulation time)
    "depart": float,            # Departure time (simulation time)
    "request_type": str,        # "arrival" or "release"

    # Bandwidth
    "bandwidth": str,           # Requested bandwidth (e.g., "50Gbps", "100Gbps")
    "mod_formats": dict,        # Available modulation formats for this bandwidth
}
```

### Example Request

```python
{
    "req_id": 42,
    "source": "0",
    "destination": "5",
    "arrive": 12.345,
    "depart": 17.890,
    "request_type": "arrival",
    "bandwidth": "100Gbps",
    "mod_formats": {
        "QPSK": {"slots": 4, "reach_km": 2000},
        "16-QAM": {"slots": 2, "reach_km": 800},
    }
}
```

---

## Request Indexing

Requests are stored in a dictionary indexed by `(request_id, time)`:

```python
requests_dict: dict[tuple[int, float], dict] = {
    (42, 12.345): {...},  # Arrival event
    (42, 17.890): {...},  # Release event
}
```

This allows multiple events (arrival/release) for the same request at different times.

---

## Request Types

### Arrival Event
```python
{
    "req_id": 42,
    "request_type": "arrival",
    "arrive": 12.345,
    ...
}
```

### Release Event
```python
{
    "req_id": 42,
    "request_type": "release",
    "depart": 17.890,
    ...
}
```

---

## Current State Tracking (SDNProps)

Request state is currently tracked in `SDNProps` (not in the request dict):

```python
# In SDNProps (fusion/core/properties.py lines 321-424)
class SDNProps:
    # Blocking
    block_reason: str | None = None  # Why request was blocked

    # Allocation tracking
    lightpath_id_list: list[int] = []  # Lightpaths used by current request
    bandwidth_list: list[float] = []    # Bandwidth allocated

    # Modulation
    modulation_list: list[str] = []    # Modulations used
```

---

## Block Reasons (Current)

From `fusion/core/properties.py` and various algorithm implementations:

```python
# Current block_reason values (strings)
block_reasons = [
    "distance",         # No valid modulation for distance
    "congestion",       # No available spectrum
    "xt_threshold",     # Crosstalk exceeded threshold
    "failure",          # Network failure
    "no_route",         # No path exists
    "snr_failure",      # SNR below threshold
]
```

---

## Mapping to Request Dataclass

| Legacy Field | Request Field | Notes |
|--------------|---------------|-------|
| `req_id` | `request_id` | Renamed for clarity |
| `source` | `source` | Direct mapping |
| `destination` | `destination` | Direct mapping |
| `arrive` | `arrive_time` | Renamed for clarity |
| `depart` | `depart_time` | Renamed for clarity |
| `bandwidth` | `bandwidth_gbps` | Parse to int, store numeric |
| `mod_formats` | `modulation_formats` | Renamed |
| `request_type` | (derived) | Use `status` instead |
| (from SDNProps) | `status` | NEW: RequestStatus enum |
| (from SDNProps) | `block_reason` | NEW: BlockReason enum |
| (from SDNProps) | `lightpath_ids` | NEW: list of allocated lightpath IDs |

---

## Bandwidth Parsing

Current format uses strings like `"50Gbps"`, `"100Gbps"`.

Conversion:
```python
# Legacy to new
bandwidth_str = "100Gbps"
bandwidth_gbps = int(bandwidth_str.replace("Gbps", ""))  # -> 100

# New to legacy
bandwidth_gbps = 100
bandwidth_str = f"{bandwidth_gbps}Gbps"  # -> "100Gbps"
```

---

## Feature Flags (Post-Allocation)

These are set after allocation attempts:

| Flag | Meaning |
|------|---------|
| `is_groomed` | Request fully served by existing lightpath capacity |
| `is_partially_groomed` | Some bandwidth from existing, rest from new lightpath |
| `is_sliced` | Request split across multiple lightpaths |
| `is_protected` | Request has 1+1 protection (backup path) |

These flags are NOT in the current request dict - they must be added to the new `Request` class.

---

## Reference Files

For the complete source of truth, see:
- `fusion/core/request.py` - Request generation
- `fusion/core/properties.py` - SDNProps (state tracking)
- `fusion/core/sdn_controller.py` - Request processing
