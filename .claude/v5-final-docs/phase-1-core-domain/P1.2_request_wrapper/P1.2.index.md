# P1.2 Request Wrapper - Index

**Sub-phase**: P1.2
**Scope**: Phase 1 - Core Domain Model only
**Goal**: Create the `Request` dataclass with status enums, lifecycle tracking, and legacy adapters

---

## Objectives

1. Define `RequestStatus` and `BlockReason` enums
2. Implement `Request` as a mutable dataclass with lifecycle tracking
3. Implement legacy adapters: `from_legacy_dict()` and `to_legacy_dict()`
4. Create comprehensive tests achieving 95% coverage

---

## Constraints

- **Additive only**: Do not modify any existing files
- **Mutable dataclass**: `Request` status changes during its lifecycle
- **Enum-based status**: Use `RequestStatus` enum, not magic strings
- **Roundtrip preservation**: Legacy conversion must preserve all data
- **No signature changes**: Existing code using request dicts works unchanged

---

## Micro-Tasks

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P1.2.a | [P1.2.a_extract_request_fields.md](P1.2.a_extract_request_fields.md) | context-extraction | Map current request dict fields |
| P1.2.b | [P1.2.b_design_request_enums.md](P1.2.b_design_request_enums.md) | design | Define RequestStatus and BlockReason |
| P1.2.c | [P1.2.c_implement_request_class.md](P1.2.c_implement_request_class.md) | refactor-plan | Implement Request dataclass |
| P1.2.d | [P1.2.d_implement_request_adapters.md](P1.2.d_implement_request_adapters.md) | refactor-plan | Implement from/to_legacy_dict |
| P1.2.e | [P1.2.e_verify_request.md](P1.2.e_verify_request.md) | verification-plan | Create tests and verify |

---

## Shared Context

- [P1.2.shared_context_request_legacy.md](P1.2.shared_context_request_legacy.md) - Current request dict structure and usage

---

## Dependencies

- P1.1 Domain Scaffolding (completed)
- `fusion/domain/__init__.py` exists

---

## Outputs

After completing all P1.2 micro-tasks:

```
fusion/
├── domain/
│   ├── __init__.py         # Updated: exports Request, RequestStatus, BlockReason
│   ├── config.py           # From P1.1
│   └── request.py          # NEW: Request, RequestStatus, BlockReason
└── tests/
    └── domain/
        ├── __init__.py
        ├── test_config.py  # From P1.1
        └── test_request.py # NEW: 95% coverage
```

---

## Request Lifecycle

```
[PENDING] ──allocate()──> [ROUTED] ──release()──> [RELEASED]
    │
    └──────allocate()──> [BLOCKED] (terminal)
```

**State Transitions**:
- `PENDING` -> `ROUTED`: Request successfully allocated
- `PENDING` -> `BLOCKED`: Request failed allocation (with `block_reason`)
- `ROUTED` -> `RELEASED`: Request completed, resources freed
- `BLOCKED` is terminal (no further transitions)

---

## Verification

After P1.2 is complete, verify:

```bash
# All tests pass
pytest fusion/tests/domain/test_request.py -v

# Coverage target met
pytest fusion/tests/domain/test_request.py --cov=fusion/domain/request --cov-report=term-missing

# Type checking passes
mypy fusion/domain/request.py

# Linting passes
ruff check fusion/domain/
ruff format --check fusion/domain/

# Existing tests still pass
pytest tests/ -v --ignore=fusion/tests/
```
