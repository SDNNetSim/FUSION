# P1.3 Lightpath Wrapper - Index

**Sub-phase**: P1.3
**Scope**: Phase 1 - Core Domain Model only
**Goal**: Create the `Lightpath` dataclass with capacity tracking and legacy adapters

---

## Objectives

1. Identify all current lightpath representations in the codebase
2. Implement `Lightpath` as a mutable dataclass with capacity management
3. Implement computed properties (utilization, num_slots, num_hops)
4. Implement legacy adapters: `from_legacy_dict()` and `to_legacy_dict()`
5. Create comprehensive tests achieving 95% coverage

---

## Constraints

- **Additive only**: Do not modify any existing files
- **Mutable dataclass**: Lightpath capacity changes during grooming
- **Capacity tracking**: Track per-request bandwidth allocations
- **Protection support**: Model 1+1 protection with backup paths
- **Roundtrip preservation**: Legacy conversion must preserve all data

---

## Micro-Tasks

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P1.3.a | [P1.3.a_extract_lightpath_fields.md](P1.3.a_extract_lightpath_fields.md) | context-extraction | Map current lightpath structures |
| P1.3.b | [P1.3.b_implement_lightpath_class.md](P1.3.b_implement_lightpath_class.md) | refactor-plan | Implement Lightpath dataclass |
| P1.3.c | [P1.3.c_implement_lightpath_adapters.md](P1.3.c_implement_lightpath_adapters.md) | refactor-plan | Implement from/to_legacy_dict |
| P1.3.d | [P1.3.d_verify_lightpath.md](P1.3.d_verify_lightpath.md) | verification-plan | Create tests and verify |

---

## Shared Context

- [P1.3.shared_context_lightpath_legacy.md](P1.3.shared_context_lightpath_legacy.md) - Current lightpath structures

---

## Dependencies

- P1.1 Domain Scaffolding (completed)
- P1.2 Request Wrapper (completed)

---

## Outputs

After completing all P1.3 micro-tasks:

```
fusion/
├── domain/
│   ├── __init__.py         # Updated: exports Lightpath
│   ├── config.py           # From P1.1
│   ├── request.py          # From P1.2
│   └── lightpath.py        # NEW: Lightpath dataclass
└── tests/
    └── domain/
        ├── __init__.py
        ├── test_config.py
        ├── test_request.py
        └── test_lightpath.py  # NEW: 95% coverage
```

---

## Lightpath Lifecycle

```
[Created] ──allocate_bandwidth()──> [Active with capacity] ──groom()──> [Capacity reduced]
    │                                        │
    │                                        └──release_bandwidth()──> [Capacity restored]
    └──release_all()──> [Released/Deleted]
```

**Capacity Invariant**:
```
remaining_bandwidth == total_bandwidth - sum(request_allocations.values())
```

---

## Verification

After P1.3 is complete, verify:

```bash
# All tests pass
pytest fusion/tests/domain/test_lightpath.py -v

# Coverage target met
pytest fusion/tests/domain/test_lightpath.py --cov=fusion/domain/lightpath --cov-report=term-missing

# Type checking passes
mypy fusion/domain/lightpath.py

# Linting passes
ruff check fusion/domain/
ruff format --check fusion/domain/

# Existing tests still pass
pytest tests/ -v --ignore=fusion/tests/
```
