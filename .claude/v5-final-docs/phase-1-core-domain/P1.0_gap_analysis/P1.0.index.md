# P1.0 Gap Analysis: Phase 1 Core Domain Completeness

## Purpose

This document provides a comprehensive gap analysis for Phase 1 of the FUSION architecture migration. It identifies all domain pieces and centralization steps that must be addressed to achieve a complete, coherent core domain model as specified in V2/V3/V4 architecture documents.

## Analysis Scope

Phase 1 covers:
- **P1.1**: SimulationConfig (frozen dataclass)
- **P1.2**: Request wrapper (mutable dataclass with lifecycle)
- **P1.3**: Lightpath wrapper (mutable dataclass)
- **P1.4**: Result objects (frozen dataclasses)
- **P1.5**: StatsCollector skeleton

## Gap Summary

| Category | Gap ID | Description | Status | Priority |
|----------|--------|-------------|--------|----------|
| State Centralization | G1.1 | Complete legacy Props class mapping | Open | Critical |
| State Centralization | G1.2 | SDNProps field distribution plan | Open | Critical |
| Domain Objects | G2.1 | Missing BlockReason enum completeness | Open | High |
| Domain Objects | G2.2 | Missing ProtectionStatus enum | Open | High |
| Domain Objects | G2.3 | Physical constants centralization | Open | Medium |
| Config Coverage | G3.1 | SimulationConfig field completeness vs cli_to_config.py | Open | High |
| Config Coverage | G3.2 | Feature flag categories documentation | Open | Medium |
| Result Objects | G4.1 | ProtectionResult for 1+1 protection | Open | High |
| Legacy Mapping | G5.1 | request.py dict format mapping | Open | High |
| Legacy Mapping | G5.2 | lightpath_status_dict structure mapping | Open | High |

---

## Detailed Gap Analysis

### G1: State Centralization Gaps

#### G1.1: Complete Legacy Props Class Mapping

**Current State**: V5 docs (P1.1-P1.5) cover high-level mapping but lack complete field-by-field centralization.

**Gap**: The following Props classes from `fusion/core/properties.py` need complete field mapping:

| Legacy Class | Target Location(s) | Status |
|-------------|-------------------|--------|
| `RoutingProps` | `RouteResult` + `SimulationConfig` | Partial |
| `SpectrumProps` | `SpectrumResult` + `Lightpath` | Partial |
| `SNRProps` | `SNRResult` + `SimulationConfig` | Partial |
| `GroomingProps` | `GroomingResult` + `NetworkState` | Partial |
| `SDNProps` | Distributed (see G1.2) | Not Started |
| `StatsProps` | `StatsCollector` | Partial |

**Resolution**: See `P1.0.a_state_centralization_map.md`

#### G1.2: SDNProps Field Distribution

**Current State**: SDNProps contains 60+ fields that serve multiple purposes.

**Gap**: Need explicit mapping of each SDNProps field to its new home:
- Request-specific fields -> `Request` class
- Lightpath-specific fields -> `Lightpath` class
- Network state fields -> `NetworkState` (Phase 2)
- Per-request tracking lists -> Result objects
- Statistical tracking -> `StatsCollector`
- Configuration -> `SimulationConfig`

**Resolution**: See `P1.0.b_sdnprops_distribution.md`

---

### G2: Domain Object Gaps

#### G2.1: BlockReason Enum Completeness

**Current State**: P1.2.b mentions BlockReason but may not cover all reasons.

**Gap**: Current blocking reasons from `StatsProps.block_reasons_dict`:
```python
block_reasons_dict = {
    "distance": None,      # Path too long for any modulation
    "congestion": None,    # No spectrum available
    "xt_threshold": None,  # Crosstalk exceeds threshold
    "failure": None,       # Link/node failure
}
```

Additional blocking reasons found in codebase:
- `snr_fail` - SNR below threshold
- `no_path` - No path exists between nodes
- `grooming_fail` - Grooming attempt failed
- `slicing_fail` - Slicing attempt failed
- `protection_fail` - Cannot establish protection path

**Resolution**: Update P1.2.b with complete BlockReason enum.

#### G2.2: Missing ProtectionStatus Enum

**Current State**: Not documented in V5 P1 docs.

**Gap**: Protection-related states from SDNProps need enum:
```python
class ProtectionStatus(Enum):
    UNPROTECTED = "unprotected"
    PROTECTED_ACTIVE_PRIMARY = "protected_active_primary"
    PROTECTED_ACTIVE_BACKUP = "protected_active_backup"
    SWITCHOVER_IN_PROGRESS = "switchover_in_progress"
    BOTH_PATHS_FAILED = "both_paths_failed"
```

**Resolution**: Add to P1.2.b or create new P1.2.b2 protection enums doc.

#### G2.3: Physical Constants Centralization

**Current State**: Constants scattered across properties.py, snr_measurements.py.

**Gap**: Need centralized constants module:
```python
# From properties.py
PLANCK_CONSTANT = 6.62607004e-34
LIGHT_FREQUENCY_CENTER = 1.9341e14
DEFAULT_INPUT_POWER = 1e-3
DEFAULT_FREQUENCY_SPACING = 12.5e9
DEFAULT_SPAN_LENGTH = 100.0
WORST_CASE_MCI = 6.3349755556585961e-27
```

**Resolution**: Add physical constants to P1.1 SimulationConfig or separate constants module.

---

### G3: Configuration Coverage Gaps

#### G3.1: SimulationConfig Field Completeness

**Current State**: P1.1.b lists config categories but may not be exhaustive.

**Gap**: Compare against `cli_to_config.py` mapping:

**General Settings** (19 fields):
- holding_time, mod_assumption, mod_assumption_path
- erlang_start, erlang_stop, erlang_step
- max_iters, guard_slots, max_segments
- thread_erlangs, dynamic_lps, fixed_grid
- pre_calc_mod_selection, spectrum_priority
- num_requests, request_distribution
- allocation_method, route_method
- save_snapshots, snapshot_step, print_step, save_step
- save_start_end_slots

**Topology Settings** (6 fields):
- network, bw_per_slot, cores_per_link
- const_link_weight, is_only_core_node, multi_fiber

**Spectrum Settings** (1 field):
- c_band

**SNR Settings** (10 fields):
- snr_type, xt_type, beta, theta
- input_power, egn_model, phi
- bi_directional, xt_noise, requested_xt

**RL Settings** (30+ fields):
- obs_space, n_trials, device
- optimize_hyperparameters, optuna_trials
- is_training, path_algorithm, path_model
- core_algorithm, core_model
- spectrum_algorithm, spectrum_model
- render_mode, super_channel_space
- alpha_start, alpha_end, alpha_update
- gamma, epsilon_start, epsilon_end, epsilon_update
- path_levels, decay_rate, feature_extractor
- gnn_type, layers, emb_dim, heads
- conf_param, cong_cutoff, reward, penalty
- dynamic_reward, core_beta

**ML Settings** (5 fields):
- deploy_model, output_train_data, ml_training
- ml_model, train_file_path, test_size

**File Settings** (1 field):
- file_type

**Resolution**: Update P1.1.b with complete field enumeration.

#### G3.2: Feature Flag Categories

**Current State**: Feature flags mentioned but not systematically documented.

**Gap**: Need explicit feature flag categories:
```python
@dataclass(frozen=True)
class FeatureFlags:
    # Core features
    grooming_enabled: bool = False
    slicing_enabled: bool = False
    protection_enabled: bool = False  # 1+1 protection

    # SNR features
    snr_validation_enabled: bool = False
    xt_validation_enabled: bool = False

    # Advanced features
    dynamic_lightpaths: bool = False
    fixed_grid_mode: bool = False
    multi_band_enabled: bool = False

    # RL features
    rl_path_selection: bool = False
    rl_core_selection: bool = False
    rl_spectrum_selection: bool = False
```

**Resolution**: Add feature flags section to P1.1.b.

---

### G4: Result Object Gaps

#### G4.1: ProtectionResult for 1+1 Protection

**Current State**: P1.4 covers RouteResult, SpectrumResult, GroomingResult, SlicingResult, SNRResult, AllocationResult.

**Gap**: Protection scenarios need dedicated result:
```python
@dataclass(frozen=True)
class ProtectionResult:
    """Result of protection path establishment or switchover."""
    primary_established: bool
    backup_established: bool
    primary_spectrum: SpectrumResult | None = None
    backup_spectrum: SpectrumResult | None = None
    switchover_triggered: bool = False
    switchover_success: bool = False
    switchover_time_ms: float | None = None
    failure_type: str | None = None  # "link", "node", "srlg", "geographic"
```

**Resolution**: Add P1.4.d2_design_protection_result.md or extend P1.4.e.

---

### G5: Legacy Mapping Gaps

#### G5.1: Request Dict Format Mapping

**Current State**: P1.2 documents Request class but legacy dict format needs explicit mapping.

**Gap**: Current request dict format from `_create_request_entry()`:
```python
{
    "req_id": request_id,
    "source": source,
    "destination": destination,
    "arrive": arrival_time,
    "depart": departure_time,
    "request_type": request_type,  # "arrival" or "release"
    "bandwidth": bandwidth,
    "mod_formats": modulation_formats,
}
```

Additional runtime fields from SDNProps:
```python
# Added during processing
"slots_needed": int
"path_list": list[int]
"path_index": int
"was_routed": bool
"was_groomed": bool
"is_sliced": bool
"block_reason": str | None
"modulation_list": list[str]
"core_list": list[int]
"band_list": list[str]
"start_slot_list": list[int]
"end_slot_list": list[int]
"lightpath_id_list": list[int]
```

**Resolution**: Update P1.2.shared_context with complete field mapping.

#### G5.2: Lightpath Status Dict Structure

**Current State**: P1.3 documents Lightpath class but legacy dict structure needs mapping.

**Gap**: `lightpath_status_dict` structure:
```python
lightpath_status_dict = {
    (src, dst): {  # sorted tuple key
        lightpath_id: {
            "path": list[int],
            "start_slot": int,
            "end_slot": int,
            "core": int,
            "band": str,
            "mod_format": str,
            "lightpath_bandwidth": float,
            "remaining_bandwidth": float,
            "path_weight": float,
            "snr_cost": float | None,
            "xt_cost": float | None,
            "is_degraded": bool,
            "requests_dict": dict[int, float],  # request_id -> allocated_bw
        }
    }
}
```

**Resolution**: Update P1.3.shared_context with complete field mapping.

---

## Resolution Sub-documents

This gap analysis is resolved by the following sub-documents:

1. **P1.0.a_state_centralization_map.md** - Complete mapping of all legacy state to new domain model
2. **P1.0.b_sdnprops_distribution.md** - Detailed SDNProps field distribution plan
3. **P1.0.c_complete_enum_catalog.md** - All domain enums with complete values

---

## Verification Checklist

Before Phase 1 implementation begins, verify:

- [ ] Every field in RoutingProps has a defined destination
- [ ] Every field in SpectrumProps has a defined destination
- [ ] Every field in SNRProps has a defined destination
- [ ] Every field in GroomingProps has a defined destination
- [ ] Every field in SDNProps has a defined destination
- [ ] Every field in StatsProps has a defined destination
- [ ] All blocking reasons are enumerated in BlockReason
- [ ] All request states are enumerated in RequestStatus
- [ ] All protection states are enumerated in ProtectionStatus
- [ ] SimulationConfig covers all cli_to_config.py parameters
- [ ] Feature flags are documented and categorized
- [ ] Legacy dict formats have complete from/to adapter specs
- [ ] Physical constants are centralized

---

## Next Steps

1. Complete P1.0.a (state centralization map)
2. Complete P1.0.b (SDNProps distribution)
3. Complete P1.0.c (enum catalog)
4. Update P1.1-P1.5 docs with any corrections from gap analysis
5. Proceed to P1.1 implementation
