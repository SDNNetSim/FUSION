# Shared Context: Current StatsProps Structure

**Purpose**: Document current statistics tracking for P1.5 StatsCollector design
**Source**: Extracted from `fusion/core/properties.py` (StatsProps) and metrics usage

---

## Current StatsProps Class

From `fusion/core/properties.py` (lines 549-612):

```python
class StatsProps:
    # Per-simulation snapshots
    snapshots_dict: dict[int, dict[str, Any]]

    # Resource usage
    cores_dict: dict[int, int]
    weights_dict: dict[str, dict[str, list]]
    modulations_used_dict: dict[str, Any]
    bandwidth_blocking_dict: dict[str | float, int]
    link_usage_dict: dict[str, dict[str, Any]]
    demand_realization_ratio: dict[str, Any]
    frag_dict: dict[str, Any]
    lp_bw_utilization_dict: dict[str, Any]

    # Blocking metrics
    block_reasons_dict: dict[str, int | float | None] = {
        "distance": None,
        "congestion": None,
        "xt_threshold": None,
        "failure": None,
    }

    # Per-simulation lists
    simulation_blocking_list: list[float]
    simulation_bitrate_blocking_list: list[float]
    transponders_list: list[int | float]
    hops_list: list[float]
    lengths_list: list[float]
    route_times_list: list[float]
    crosstalk_list: list[float]
    snr_list: list[float]

    # Protection/survivability
    protection_switchovers: int
    protection_failures: int
    failure_induced_blocks: int
    switchover_times: list[float]
    recovery_times_ms: list[float]
    failure_window_bp: list[float]
    recovery_events: list[dict[str, Any]]
```

---

## Snapshot Keys

From properties.py (lines 20-26):

```python
SNAP_KEYS_LIST = [
    "occupied_slots",
    "guard_slots",
    "active_requests",
    "blocking_prob",
    "num_segments",
]
```

---

## run_comparison.py Expected Format

The `run_comparison.py` script expects statistics in this format:

```python
comparison_results = {
    # Blocking
    "blocking_probability": float,      # Overall BP
    "block_reasons": dict[str, int],    # Reason counts

    # Feature usage
    "modulations_used": dict[str, int],
    "grooming_ratio": float,
    "slicing_ratio": float,
    "protection_ratio": float,

    # SNR
    "average_snr": float,
    "snr_list": list[float],

    # Totals
    "total_requests": int,
    "successful_requests": int,
    "blocked_requests": int,
}
```

---

## Mapping to StatsCollector

| Legacy Field | StatsCollector Field | Notes |
|--------------|---------------------|-------|
| `simulation_blocking_list[-1]` | `blocking_probability` | Computed property |
| `block_reasons_dict` | `block_reasons` | Use BlockReason enum keys |
| `modulations_used_dict` | `modulations_used` | Direct mapping |
| `snr_list` | `snr_values` | Renamed |
| (computed) | `total_requests` | Counter |
| (computed) | `successful_requests` | Counter |
| (computed) | `blocked_requests` | Counter |
| (computed) | `groomed_requests` | Counter |
| (computed) | `sliced_requests` | Counter |
| (computed) | `protected_requests` | Counter |

---

## Phase 1 Scope

StatsCollector in Phase 1 tracks:

1. **Request counters**: total, successful, blocked
2. **Block reasons**: Using BlockReason enum
3. **Feature usage**: groomed, sliced, protected counts
4. **Modulation usage**: format -> count
5. **SNR values**: list for average calculation

NOT in Phase 1 scope:
- Snapshot tracking (requires simulation loop integration)
- Link usage tracking (requires NetworkState integration)
- Fragmentation metrics (requires spectrum analysis)
- Per-bandwidth blocking (advanced feature)

---

## Reference Files

For complete source of truth, see:
- `fusion/core/properties.py` - StatsProps class
- `fusion/core/metrics.py` - Metrics calculation
- `fusion/cli/run_comparison.py` - Expected output format
