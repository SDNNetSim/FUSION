# Task ID: P1.5.b - Implement StatsCollector

**Sub-phase**: P1.5 Stats Collector
**Scope**: Phase 1 - Core Domain Model only
**Task type**: refactor-plan

---

## Purpose

Implement the base `StatsCollector` class with all fields and computed properties.

---

## Context to load before running this task

- `.claude/v5-final-docs/phase-1-core-domain/P1.5_stats_collector/P1.5.a_design_stats_collector.md`
- `fusion/domain/config.py` (SimulationConfig)

---

## Outputs

### Create Directory Structure

```bash
mkdir -p fusion/stats
mkdir -p fusion/tests/stats
```

### Create `fusion/stats/__init__.py`

```python
"""FUSION Statistics Package."""

from fusion.stats.collector import StatsCollector

__all__ = ["StatsCollector"]
```

### Create `fusion/stats/collector.py`

```python
"""
StatsCollector - Centralized statistics collection.

This module provides the StatsCollector class for aggregating
simulation metrics from request processing outcomes.
"""

from __future__ import annotations

from collections import defaultdict
from dataclasses import dataclass, field
from typing import TYPE_CHECKING, Any

if TYPE_CHECKING:
    from fusion.domain.config import SimulationConfig
    from fusion.domain.request import Request
    from fusion.domain.results import AllocationResult


@dataclass
class StatsCollector:
    """
    Centralized statistics collection for simulation runs.

    StatsCollector aggregates metrics from request processing,
    consuming domain objects (Request, AllocationResult) and
    producing statistics compatible with run_comparison.py.

    Owned by SimulationEngine, receives recording calls after
    each request is processed.

    Attributes:
        config: Simulation configuration (for context)

        Request Counters:
            total_requests: Total arrivals processed
            successful_requests: Requests that were routed
            blocked_requests: Requests that were blocked

        Block Reasons:
            block_reasons: Maps reason string -> count

        Feature Tracking:
            groomed_requests: Fully groomed requests
            partially_groomed_requests: Partially groomed requests
            sliced_requests: Sliced requests
            protected_requests: Protected requests

        Modulation Tracking:
            modulations_used: Maps format name -> count

        SNR Tracking:
            snr_values: List of SNR measurements

        Bandwidth Tracking:
            total_bandwidth_requested_gbps: Sum of request bandwidths
            total_bandwidth_allocated_gbps: Sum of allocated bandwidths

    Example:
        >>> from fusion.domain.config import SimulationConfig
        >>> config = SimulationConfig(...)
        >>> collector = StatsCollector(config)
        >>> collector.record_arrival(request, result)
        >>> print(f"BP: {collector.blocking_probability:.2%}")
    """

    config: "SimulationConfig"

    # =========================================================================
    # Request Counters
    # =========================================================================
    total_requests: int = 0
    successful_requests: int = 0
    blocked_requests: int = 0

    # =========================================================================
    # Block Reasons
    # =========================================================================
    block_reasons: dict[str, int] = field(
        default_factory=lambda: defaultdict(int)
    )

    # =========================================================================
    # Feature Tracking
    # =========================================================================
    groomed_requests: int = 0
    partially_groomed_requests: int = 0
    sliced_requests: int = 0
    protected_requests: int = 0

    # =========================================================================
    # Modulation Tracking
    # =========================================================================
    modulations_used: dict[str, int] = field(
        default_factory=lambda: defaultdict(int)
    )

    # =========================================================================
    # SNR Tracking
    # =========================================================================
    snr_values: list[float] = field(default_factory=list)

    # =========================================================================
    # Bandwidth Tracking
    # =========================================================================
    total_bandwidth_requested_gbps: int = 0
    total_bandwidth_allocated_gbps: int = 0

    # =========================================================================
    # Computed Properties
    # =========================================================================
    @property
    def blocking_probability(self) -> float:
        """
        Calculate blocking probability.

        Returns:
            Ratio of blocked to total requests (0.0 to 1.0).
            Returns 0.0 if no requests have been processed.
        """
        if self.total_requests == 0:
            return 0.0
        return self.blocked_requests / self.total_requests

    @property
    def success_rate(self) -> float:
        """
        Calculate success rate (complement of blocking probability).

        Returns:
            Ratio of successful to total requests (0.0 to 1.0).
        """
        return 1.0 - self.blocking_probability

    @property
    def average_snr(self) -> float:
        """
        Calculate average SNR across all measurements.

        Returns:
            Mean SNR in dB, or 0.0 if no measurements.
        """
        if not self.snr_values:
            return 0.0
        return sum(self.snr_values) / len(self.snr_values)

    @property
    def grooming_ratio(self) -> float:
        """
        Ratio of groomed requests to successful requests.

        Includes both fully and partially groomed requests.

        Returns:
            Ratio (0.0 to 1.0), or 0.0 if no successful requests.
        """
        if self.successful_requests == 0:
            return 0.0
        total_groomed = self.groomed_requests + self.partially_groomed_requests
        return total_groomed / self.successful_requests

    @property
    def slicing_ratio(self) -> float:
        """
        Ratio of sliced requests to successful requests.

        Returns:
            Ratio (0.0 to 1.0), or 0.0 if no successful requests.
        """
        if self.successful_requests == 0:
            return 0.0
        return self.sliced_requests / self.successful_requests

    @property
    def protection_ratio(self) -> float:
        """
        Ratio of protected requests to successful requests.

        Returns:
            Ratio (0.0 to 1.0), or 0.0 if no successful requests.
        """
        if self.successful_requests == 0:
            return 0.0
        return self.protected_requests / self.successful_requests

    @property
    def bandwidth_utilization(self) -> float:
        """
        Ratio of allocated bandwidth to requested bandwidth.

        Returns:
            Ratio (0.0 to 1.0), or 0.0 if no bandwidth requested.
        """
        if self.total_bandwidth_requested_gbps == 0:
            return 0.0
        return self.total_bandwidth_allocated_gbps / self.total_bandwidth_requested_gbps

    # =========================================================================
    # Recording Methods (stubs - implemented in P1.5.c)
    # =========================================================================
    def record_arrival(
        self,
        request: "Request",
        result: "AllocationResult",
    ) -> None:
        """
        Record the outcome of a request arrival.

        Args:
            request: The request that was processed
            result: The allocation result
        """
        raise NotImplementedError("Implement in P1.5.c")

    def record_snr(self, snr_db: float) -> None:
        """
        Record an SNR measurement.

        Args:
            snr_db: SNR value in dB
        """
        raise NotImplementedError("Implement in P1.5.c")

    def record_release(self, request: "Request") -> None:
        """
        Record a request release.

        Args:
            request: The request being released
        """
        raise NotImplementedError("Implement in P1.5.c")

    # =========================================================================
    # Export Methods (stubs - implemented in P1.5.d)
    # =========================================================================
    def to_comparison_format(self) -> dict[str, Any]:
        """
        Export statistics in run_comparison.py format.

        Returns:
            Dictionary compatible with comparison scripts
        """
        raise NotImplementedError("Implement in P1.5.d")

    def reset(self) -> None:
        """
        Reset all counters and lists.
        """
        raise NotImplementedError("Implement in P1.5.d")
```

### Create `fusion/tests/stats/__init__.py`

```python
"""Tests for fusion.stats package."""
```

---

## Verification

```bash
# Verify package is importable
python -c "from fusion.stats import StatsCollector; print('OK')"

# Verify computed properties work
python -c "
from fusion.stats import StatsCollector
from fusion.domain import SimulationConfig

config = SimulationConfig(
    network_name='test',
    cores_per_link=1,
    band_list=('c',),
    band_slots={'c': 320},
    guard_slots=1,
    num_requests=100,
    erlang=50.0,
    holding_time=5.0,
    route_method='k_shortest_path',
    k_paths=3,
    allocation_method='first_fit',
)
stats = StatsCollector(config)
print(f'BP: {stats.blocking_probability}')
"

# Lint
ruff check fusion/stats/
ruff format --check fusion/stats/
```

---

## Next Task

Proceed to [P1.5.c_implement_recording_methods.md](P1.5.c_implement_recording_methods.md).
