# P1.5 Stats Collector - Index

**Sub-phase**: P1.5
**Scope**: Phase 1 - Core Domain Model only
**Goal**: Create the `StatsCollector` skeleton with recording methods and export

---

## Objectives

1. Design `StatsCollector` API that consumes domain objects
2. Implement counters for blocking, grooming, slicing, protection
3. Implement recording methods for arrivals and SNR
4. Implement export method compatible with `run_comparison.py`
5. Create comprehensive tests achieving 90% coverage

---

## Constraints

- **Additive only**: Do not modify any existing files
- **No legacy dependencies**: StatsCollector uses domain objects only
- **run_comparison.py compatibility**: Export format must match legacy
- **Stateless recording**: Each `record_*` call is independent

---

## Micro-Tasks

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P1.5.a | [P1.5.a_design_stats_collector.md](P1.5.a_design_stats_collector.md) | design | Design StatsCollector API |
| P1.5.b | [P1.5.b_implement_stats_collector.md](P1.5.b_implement_stats_collector.md) | refactor-plan | Implement base class |
| P1.5.c | [P1.5.c_implement_recording_methods.md](P1.5.c_implement_recording_methods.md) | refactor-plan | Implement record_* methods |
| P1.5.d | [P1.5.d_implement_export_methods.md](P1.5.d_implement_export_methods.md) | refactor-plan | Implement export methods |
| P1.5.e | [P1.5.e_verify_stats_collector.md](P1.5.e_verify_stats_collector.md) | verification-plan | Create tests and verify |

---

## Shared Context

- [P1.5.shared_context_stats_props.md](P1.5.shared_context_stats_props.md) - Current StatsProps structure

---

## Dependencies

- P1.1 Domain Scaffolding (completed) - `SimulationConfig`
- P1.2 Request Wrapper (completed) - `Request`, `BlockReason`
- P1.4 Result Objects (completed) - `AllocationResult`

---

## Outputs

After completing all P1.5 micro-tasks:

```
fusion/
├── stats/
│   ├── __init__.py         # Package with StatsCollector export
│   └── collector.py        # StatsCollector class
└── tests/
    └── stats/
        ├── __init__.py
        └── test_collector.py  # 90% coverage
```

---

## StatsCollector API Overview

```python
class StatsCollector:
    def __init__(self, config: SimulationConfig): ...

    # Recording methods
    def record_arrival(self, request: Request, result: AllocationResult) -> None: ...
    def record_snr(self, snr_db: float) -> None: ...
    def record_release(self, request: Request) -> None: ...

    # Computed properties
    @property
    def blocking_probability(self) -> float: ...
    @property
    def average_snr(self) -> float: ...

    # Export
    def to_comparison_format(self) -> dict[str, Any]: ...
```

---

## What StatsCollector Tracks (Phase 1)

### Counters
- `total_requests`: Total arrivals processed
- `successful_requests`: Requests that were routed
- `blocked_requests`: Requests that were blocked

### Blocking Breakdown
- `block_reasons`: Dict mapping BlockReason -> count

### Feature Tracking
- `groomed_requests`: Requests using existing capacity
- `sliced_requests`: Requests split across lightpaths
- `protected_requests`: Requests with 1+1 protection

### Modulation Tracking
- `modulations_used`: Dict mapping modulation format -> count

### SNR Tracking
- `snr_values`: List of SNR measurements

---

## Verification

After P1.5 is complete, verify:

```bash
# All tests pass
pytest fusion/tests/stats/test_collector.py -v

# Coverage target met
pytest fusion/tests/stats/test_collector.py --cov=fusion/stats/collector --cov-report=term-missing

# Type checking passes
mypy fusion/stats/collector.py

# Linting passes
ruff check fusion/stats/
ruff format --check fusion/stats/

# Existing tests still pass
pytest tests/ -v --ignore=fusion/tests/
```
