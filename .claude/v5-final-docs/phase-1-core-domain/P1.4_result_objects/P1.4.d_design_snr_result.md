# Task ID: P1.4.d - Design SNRResult

**Sub-phase**: P1.4 Result Objects
**Scope**: Phase 1 - Core Domain Model only
**Task type**: design

---

## Purpose

Design the `SNRResult` frozen dataclass representing SNR validation output.

---

## Context to load before running this task

- `.claude/v5-final-docs/phase-1-core-domain/P1.4_result_objects/P1.4.shared_context_current_returns.md`
- `.claude/v4-docs/architecture/result_objects.md` (SNRResult section)

---

## Outputs

### SNRResult Specification

```python
@dataclass(frozen=True)
class SNRResult:
    """
    Result of SNR validation pipeline.

    Indicates whether the signal-to-noise ratio meets the threshold
    required for the selected modulation format.

    Attributes:
        passed: Whether SNR meets threshold (primary success indicator)
        snr_db: Calculated SNR value in dB
        required_snr_db: Threshold required for modulation format
        margin_db: SNR margin (snr_db - required_snr_db)
        failure_reason: Explanation if validation failed
        link_snr_values: Per-link SNR breakdown for debugging

    Invariants:
        - margin_db == snr_db - required_snr_db
        - If passed=False and snr_db < required_snr_db, margin_db is negative
    """

    passed: bool
    snr_db: float = 0.0
    required_snr_db: float = 0.0
    margin_db: float = 0.0
    failure_reason: str | None = None
    link_snr_values: dict[tuple[str, str], float] = field(default_factory=dict)

    def __post_init__(self) -> None:
        """Validate SNR result after creation."""
        # Note: We don't enforce margin == snr - required because
        # the caller might provide pre-calculated margin
        pass

    @property
    def is_degraded(self) -> bool:
        """True if SNR passed but with low margin (< 1 dB)."""
        return self.passed and 0 <= self.margin_db < 1.0

    @property
    def has_link_breakdown(self) -> bool:
        """True if per-link SNR values are available."""
        return len(self.link_snr_values) > 0

    @classmethod
    def success(
        cls,
        snr_db: float,
        required_snr_db: float,
        link_snr_values: dict[tuple[str, str], float] | None = None,
    ) -> SNRResult:
        """Create successful SNR result."""
        margin = snr_db - required_snr_db
        return cls(
            passed=True,
            snr_db=snr_db,
            required_snr_db=required_snr_db,
            margin_db=margin,
            failure_reason=None,
            link_snr_values=link_snr_values or {},
        )

    @classmethod
    def failure(
        cls,
        snr_db: float,
        required_snr_db: float,
        reason: str = "SNR below threshold",
        link_snr_values: dict[tuple[str, str], float] | None = None,
    ) -> SNRResult:
        """Create failed SNR result."""
        margin = snr_db - required_snr_db
        return cls(
            passed=False,
            snr_db=snr_db,
            required_snr_db=required_snr_db,
            margin_db=margin,
            failure_reason=reason,
            link_snr_values=link_snr_values or {},
        )

    @classmethod
    def skipped(cls) -> SNRResult:
        """Create result for when SNR validation is disabled."""
        return cls(
            passed=True,
            snr_db=0.0,
            required_snr_db=0.0,
            margin_db=0.0,
            failure_reason=None,
        )

    def get_weakest_link(self) -> tuple[tuple[str, str], float] | None:
        """
        Get the link with lowest SNR.

        Returns:
            Tuple of (link, snr_db) or None if no link breakdown
        """
        if not self.link_snr_values:
            return None
        return min(self.link_snr_values.items(), key=lambda x: x[1])
```

---

## Design Decisions

### 1. passed is Primary Flag

The `passed` field is the primary success indicator:
- `passed=True`: SNR meets threshold, can proceed
- `passed=False`: SNR too low, allocation should fail

### 2. Margin Calculation

Margin is pre-calculated for convenience:
```python
margin_db = snr_db - required_snr_db
```
- Positive margin: SNR exceeds requirement
- Negative margin: SNR below requirement
- Zero or small margin: Marginal case

### 3. Link Breakdown

Optional per-link SNR values for debugging:
```python
link_snr_values = {
    ("0", "2"): 18.5,
    ("2", "5"): 15.2,  # Weakest link
}
```

### 4. is_degraded Property

Identifies cases where SNR passes but is marginal:
```python
is_degraded = passed and 0 <= margin_db < 1.0
```

---

## Usage Examples

```python
# Successful validation
result = SNRResult.success(
    snr_db=18.5,
    required_snr_db=15.0,
    link_snr_values={("0", "2"): 18.5, ("2", "5"): 19.0},
)
assert result.passed
assert result.margin_db == 3.5
assert not result.is_degraded

# Failed validation
result = SNRResult.failure(
    snr_db=12.0,
    required_snr_db=15.0,
    reason="SNR too low for QPSK",
)
assert not result.passed
assert result.margin_db == -3.0
assert result.failure_reason == "SNR too low for QPSK"

# Marginal pass
result = SNRResult.success(snr_db=15.5, required_snr_db=15.0)
assert result.passed
assert result.is_degraded  # margin < 1.0

# SNR validation disabled
result = SNRResult.skipped()
assert result.passed
```

---

## Failure Reasons

Common failure reasons to use:
- `"SNR below threshold"` - Generic failure
- `"SNR too low for {modulation}"` - Modulation-specific
- `"Crosstalk degraded SNR"` - XT-related
- `"Path too long for modulation"` - Distance-related

---

## Next Task

Proceed to [P1.4.e_design_allocation_result.md](P1.4.e_design_allocation_result.md).
