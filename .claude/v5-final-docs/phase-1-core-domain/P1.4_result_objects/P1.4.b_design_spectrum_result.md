# Task ID: P1.4.b - Design SpectrumResult

**Sub-phase**: P1.4 Result Objects
**Scope**: Phase 1 - Core Domain Model only
**Task type**: design

---

## Purpose

Design the `SpectrumResult` frozen dataclass representing spectrum assignment output.

---

## Context to load before running this task

- `.claude/v5-final-docs/phase-1-core-domain/P1.4_result_objects/P1.4.shared_context_current_returns.md`
- `.claude/v4-docs/architecture/result_objects.md` (SpectrumResult section)
- `fusion/core/properties.py` (SpectrumProps class, lines 74-123)

---

## Outputs

### SpectrumResult Specification

```python
@dataclass(frozen=True)
class SpectrumResult:
    """
    Result of spectrum assignment pipeline.

    Indicates whether contiguous spectrum was found and provides
    the allocation details (slot range, core, band, modulation).

    Attributes:
        is_free: Whether spectrum assignment was successful
        start_slot: First slot index (valid only if is_free=True)
        end_slot: Last slot index exclusive (valid only if is_free=True)
        core: Core number for MCF (valid only if is_free=True)
        band: Frequency band (valid only if is_free=True)
        modulation: Selected modulation format
        slots_needed: Number of slots required (including guard band)

        Backup spectrum (for 1+1 protection):
            backup_start_slot: Backup spectrum start
            backup_end_slot: Backup spectrum end
            backup_core: Backup core number
            backup_band: Backup frequency band

    Invariants:
        - If is_free=False, slot fields are not meaningful
        - If is_free=True, end_slot > start_slot
        - If backup fields are set, all backup fields must be set
    """

    is_free: bool

    # Primary allocation (meaningful only if is_free=True)
    start_slot: int = 0
    end_slot: int = 0
    core: int = 0
    band: str = "c"
    modulation: str = ""
    slots_needed: int = 0

    # Backup allocation (for 1+1 protection)
    backup_start_slot: int | None = None
    backup_end_slot: int | None = None
    backup_core: int | None = None
    backup_band: str | None = None

    def __post_init__(self) -> None:
        """Validate spectrum result after creation."""
        if self.is_free:
            if self.end_slot <= self.start_slot:
                raise ValueError("end_slot must be > start_slot when is_free=True")
            if self.slots_needed <= 0:
                raise ValueError("slots_needed must be > 0 when is_free=True")

    @property
    def num_slots(self) -> int:
        """Number of slots allocated (0 if not free)."""
        if not self.is_free:
            return 0
        return self.end_slot - self.start_slot

    @property
    def has_backup(self) -> bool:
        """True if backup spectrum is allocated."""
        return self.backup_start_slot is not None

    @classmethod
    def not_found(cls, slots_needed: int = 0) -> SpectrumResult:
        """Create result for failed spectrum assignment."""
        return cls(is_free=False, slots_needed=slots_needed)

    @classmethod
    def from_spectrum_props(cls, spectrum_props: Any) -> SpectrumResult:
        """
        Create from legacy SpectrumProps or dict.

        Args:
            spectrum_props: Legacy SpectrumProps object or dict

        Returns:
            New SpectrumResult instance
        """
        if isinstance(spectrum_props, dict):
            return cls(
                is_free=spectrum_props.get("is_free", False),
                start_slot=spectrum_props.get("start_slot", 0),
                end_slot=spectrum_props.get("end_slot", 0),
                core=spectrum_props.get("core_number", spectrum_props.get("core", 0)),
                band=spectrum_props.get("band", "c"),
                modulation=spectrum_props.get("modulation", ""),
                slots_needed=spectrum_props.get("slots_needed", 0),
            )

        # Handle SpectrumProps object
        return cls(
            is_free=spectrum_props.is_free,
            start_slot=spectrum_props.start_slot or 0,
            end_slot=spectrum_props.end_slot or 0,
            core=spectrum_props.core_number or 0,
            band=spectrum_props.current_band or "c",
            modulation=spectrum_props.modulation or "",
            slots_needed=spectrum_props.slots_needed or 0,
        )

    def to_allocation_dict(self) -> dict[str, Any]:
        """
        Convert to allocation dictionary for legacy compatibility.

        Returns:
            Dictionary with allocation details
        """
        return {
            "is_free": self.is_free,
            "start_slot": self.start_slot,
            "end_slot": self.end_slot,
            "core_number": self.core,
            "band": self.band,
            "modulation": self.modulation,
            "slots_needed": self.slots_needed,
        }
```

---

## Design Decisions

### 1. is_free as Primary Flag

The `is_free` field is the primary success indicator:
- `is_free=True`: Spectrum found, slot fields are valid
- `is_free=False`: No spectrum, slot fields are default/ignored

### 2. Default Values for Slot Fields

When `is_free=False`, slot fields have default values (0):
```python
result = SpectrumResult.not_found()
# result.start_slot == 0 (ignored)
# result.end_slot == 0 (ignored)
```

### 3. Validation Only When is_free=True

Validation runs only for successful assignments:
```python
if self.is_free:
    if self.end_slot <= self.start_slot:
        raise ValueError(...)
```

---

## Usage Examples

```python
# Failed spectrum assignment
result = SpectrumResult.not_found(slots_needed=8)
assert not result.is_free
assert result.num_slots == 0

# Successful assignment
result = SpectrumResult(
    is_free=True,
    start_slot=100,
    end_slot=108,
    core=0,
    band="c",
    modulation="QPSK",
    slots_needed=8,
)
assert result.is_free
assert result.num_slots == 8

# With backup allocation
result = SpectrumResult(
    is_free=True,
    start_slot=100,
    end_slot=108,
    core=0,
    band="c",
    modulation="QPSK",
    slots_needed=8,
    backup_start_slot=200,
    backup_end_slot=208,
    backup_core=1,
    backup_band="c",
)
assert result.has_backup
```

---

## Next Task

Proceed to [P1.4.c_design_grooming_slicing_results.md](P1.4.c_design_grooming_slicing_results.md).
