# Shared Context: Current Return Types

**Purpose**: Document current algorithm return types for P1.4 result object design
**Source**: Extracted from routing, spectrum, SNR modules and properties classes

---

## Current Return Types Inventory

### Routing Returns

From `fusion/core/properties.py` (RoutingProps):

```python
class RoutingProps:
    paths_matrix: list[list[str]]           # Candidate paths
    modulation_formats_matrix: list[list[str]]  # Modulations per path
    weights_list: list[float]               # Path weights/lengths
    path_index_list: list[int]              # Indices for pre-calculated paths

    # For 1+1 protection
    backup_paths_matrix: list[list[int] | None]
    backup_modulation_formats_matrix: list[list[str]]
```

**Current Usage Pattern**:
```python
routing_props = routing.get_route(request, engine_props)
if not routing_props.paths_matrix:
    # No route found
    return None
```

---

### Spectrum Assignment Returns

From `fusion/modules/spectrum/best_fit.py` (lines 52-98):

```python
def assign(...) -> dict[str, Any] | None:
    """Returns dict or None if no spectrum available."""
    return {
        "start_slot": int,
        "end_slot": int,
        "core_number": int,
        "band": str,
        "is_free": bool,
        "slots_needed": int,
    }
```

From `fusion/core/properties.py` (SpectrumProps):

```python
class SpectrumProps:
    start_slot: int | None
    end_slot: int | None
    core_number: int | None
    current_band: str | None
    is_free: bool
    slots_needed: int | None
    modulation: str | None

    # For protection
    backup_path: list[int] | None
```

---

### Grooming Returns

Currently implicit in `fusion/core/grooming.py`:

```python
# Grooming logic sets flags and returns boolean or modifies state
groomed_bandwidth = ...  # Amount groomed from existing lightpaths
remaining_bandwidth = ... # Amount still needed
lightpaths_used = [...]   # IDs of lightpaths used for grooming
```

**Implied Structure**:
```python
{
    "fully_groomed": bool,       # All bandwidth from existing
    "partially_groomed": bool,   # Some from existing, rest needs new LP
    "bandwidth_groomed": float,  # Amount groomed
    "remaining_bandwidth": float,  # Still needed
    "lightpaths_used": list[int],  # LPs used
}
```

---

### Slicing Returns

From `fusion/modules/spectrum/light_path_slicing.py`:

```python
# Returns list of created lightpath IDs or empty list on failure
{
    "success": bool,
    "num_slices": int,
    "slice_bandwidth": int,
    "lightpaths_created": list[int],
}
```

---

### SNR Validation Returns

From SNR module returns:

```python
{
    "passed": bool,
    "snr_value": float,
    "threshold": float,
    "margin": float,
}
```

From `fusion/core/properties.py` (SDNProps):

```python
snr_list: list[float]      # SNR values recorded
block_reason: str | None   # Set to "snr_failure" if fails
```

---

## Mapping to Result Objects

| Current Structure | New Result Object | Key Fields |
|-------------------|-------------------|------------|
| `RoutingProps` | `RouteResult` | paths, weights, modulations |
| `SpectrumProps` / dict | `SpectrumResult` | is_free, slots, core, band |
| Grooming state | `GroomingResult` | fully/partially_groomed, bandwidth |
| Slicing return | `SlicingResult` | success, num_slices, lightpaths |
| SNR validation | `SNRResult` | passed, snr_db, threshold |
| Final outcome | `AllocationResult` | success, lightpaths, block_reason |

---

## Invariants to Enforce

### RouteResult
- `len(paths) == len(weights) == len(modulations)`
- Each path has at least 2 nodes
- If has_protection, backup arrays have same length

### SpectrumResult
- If `is_free=False`, slot fields are ignored
- `end_slot > start_slot` when `is_free=True`

### GroomingResult
- `fully_groomed` and `partially_groomed` are mutually exclusive
- If either is True, `lightpaths_used` is non-empty

### AllocationResult
- If `success=True`: at least one lightpath created or groomed
- If `success=False`: `block_reason` is set
- `total_bandwidth > 0` when `success=True`

---

## Block Reason Mapping

| Current String | BlockReason Enum |
|----------------|------------------|
| "distance" | `NO_MODULATION` |
| "congestion" | `CONGESTION` |
| "no_spectrum" | `NO_SPECTRUM` |
| "snr_failure" | `SNR_FAILURE` |
| "xt_threshold" | `XT_FAILURE` |
| "no_route" | `NO_ROUTE` |

---

## Reference Files

For complete source of truth, see:
- `fusion/core/properties.py` - RoutingProps, SpectrumProps, SDNProps
- `fusion/modules/routing/*.py` - Routing algorithm returns
- `fusion/modules/spectrum/*.py` - Spectrum assignment returns
- `fusion/core/grooming.py` - Grooming logic
