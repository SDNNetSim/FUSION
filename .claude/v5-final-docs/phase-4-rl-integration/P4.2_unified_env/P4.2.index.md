# P4.2 Index - UnifiedSimEnv Wiring

**Phase:** 4 - RL Integration
**Sub-phase:** P4.2
**Version:** v5.1 (Gap Analysis Complete)
**Status:** Ready for Implementation
**Last Updated:** 2024

## Goals

Create `UnifiedSimEnv`, a Gymnasium-compatible environment that uses the V4 simulation stack (SimulationEngine, SDNOrchestrator, NetworkState) through `RLSimulationAdapter`. This replaces the legacy `GeneralSimEnv` which duplicates simulation logic.

### Core Principle: Single Simulation Stack

`UnifiedSimEnv` uses the exact same pipelines and orchestrator as non-RL simulation. The environment is a thin wrapper that:
1. Manages episode lifecycle (reset, step)
2. Generates observations from domain objects
3. Delegates allocation decisions to `RLSimulationAdapter`

## Key Deliverables

1. **`fusion/rl/environments/__init__.py`** - Package with exports
2. **`fusion/rl/environments/unified_env.py`** - `UnifiedSimEnv` Gymnasium environment
3. **`fusion/rl/environments/wrappers.py`** - `ActionMaskWrapper` for SB3 integration

## Constraints

1. **Gymnasium Compliance**: Must pass `gymnasium.utils.env_checker`
2. **V4 Stack Usage**: Uses SimulationEngine, not legacy engine_obj
3. **Action Masking**: Mask in `info["action_mask"]` for SB3 MaskablePPO
4. **Deterministic Seeding**: Same seed = identical episodes
5. **No Duplicated Logic**: All allocation through adapter/orchestrator

## Dependencies

- **Phase 1**: `SimulationConfig`, `Request`, result types
- **Phase 2**: `NetworkState`
- **Phase 3**: `SDNOrchestrator`, `PipelineFactory`
- **P4.1**: `RLSimulationAdapter`, `PathOption`

## Micro-Tasks

| ID | File | Type | Description |
|----|------|------|-------------|
| P4.2.a | `P4.2.a_context_extraction_general_sim_env.md` | context-extraction | Document GeneralSimEnv behavior for parity |
| P4.2.b | `P4.2.b_design_unified_env.md` | design | Design UnifiedSimEnv class |
| P4.2.c | `P4.2.c_wiring_plan_sim_engine.md` | wiring-plan | Plan integration with SimulationEngine |
| P4.2.d | `P4.2.d_action_masking_design.md` | design | Design action masking integration |
| P4.2.e | `P4.2.e_verification_plan.md` | verification-plan | Define unit tests for environment |
| P4.2.f | `P4.2.f_graph_observation_support.md` | design | Graph observations for GNN feature extractors (Gap-filling) |

## Shared Context Files

- `P4.2.shared_context_env_requirements.md` - Gymnasium requirements and SB3 integration

## Exit Criteria

### Core
- [ ] `UnifiedSimEnv` passes `gymnasium.utils.env_checker`
- [ ] Observation and action spaces correctly defined
- [ ] Action mask in `info["action_mask"]` after reset and step
- [ ] Same seed produces identical episode trajectories
- [ ] `ActionMaskWrapper` works with SB3 MaskablePPO
- [ ] All unit tests pass with >= 80% coverage
- [ ] Code passes ruff and mypy

### Gap-Filling (P4.2.f)
- [ ] Graph observations (x, edge_index, edge_attr, path_masks) supported
- [ ] Configurable observation space (obs_1 through obs_8)
- [ ] `request_bandwidth` observation feature supported
- [ ] `PathEncoder` correctly generates path-to-edge masks
- [ ] Compatible with Graphormer, PathGNN, PathGNNCached feature extractors

## File Inventory

```
P4.2_unified_env/
├── P4.2.index.md                              # This file
├── P4.2.shared_context_env_requirements.md    # Shared context
├── P4.2.a_context_extraction_general_sim_env.md  # Context extraction
├── P4.2.b_design_unified_env.md               # Design task
├── P4.2.c_wiring_plan_sim_engine.md           # Wiring plan
├── P4.2.d_action_masking_design.md            # Design task
├── P4.2.e_verification_plan.md                # Verification
└── P4.2.f_graph_observation_support.md        # Gap-filling (NEW)
```

**Total:** 8 files (1 index, 1 shared context, 6 micro-tasks)

## Implementation Order

1. **P4.2.a** - Extract GeneralSimEnv patterns for parity
2. **P4.2.b** - Design UnifiedSimEnv class
3. **P4.2.c** - Plan SimulationEngine wiring
4. **P4.2.d** - Design action masking integration
5. **P4.2.e** - Define verification tests
6. **P4.2.f** - Add graph observation support (GNN compatibility)

## Next Sub-Phase

After P4.2 completion, proceed to **P4.3: Migrate Existing RL Experiments**.
