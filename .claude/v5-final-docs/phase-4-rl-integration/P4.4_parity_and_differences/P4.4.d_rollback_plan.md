# Task ID: P4.4.d - Rollback Plan

**Sub-phase:** P4.4
**Scope:** Phase 4 - RL Integration only
**Task type:** migration-plan

## Purpose

Define procedures for quickly reverting to `GeneralSimEnv` if issues are discovered with `UnifiedSimEnv`, ensuring minimal disruption to ongoing experiments and production use.

## Context to load before running this task

- `.claude/v5-final-docs/phase-4-rl-integration/P4.3_migrate_experiments/P4.3.b_migration_plan_factory.md`
- `.claude/v5-final-docs/phase-4-rl-integration/P4.3_migrate_experiments/P4.3.c_deprecation_plan.md`

## Outputs

### 1. Rollback Procedures

#### 1.1 Immediate Rollback (Environment Variable)

**When to use**: Urgent issues, production outage, immediate revert needed.

```bash
# Option 1: Set environment variable
export USE_UNIFIED_ENV=0

# Option 2: Explicit legacy selection
export RL_ENV_TYPE=legacy

# Run your training/evaluation as normal
python train.py --config config.ini
```

**Effect**: All environments created via `create_sim_env()` will use `GeneralSimEnv`.

#### 1.2 Code-Level Rollback

**When to use**: Targeted rollback for specific scripts.

```python
from fusion.modules.rl.gymnasium_envs import create_sim_env, EnvType

# Explicitly request legacy environment
env = create_sim_env(config, env_type=EnvType.LEGACY)
```

#### 1.3 Config File Rollback

**When to use**: Persistent rollback for specific experiments.

```ini
# config.ini
[rl]
use_unified_env = false
```

#### 1.4 Global Rollback (Disable Feature)

**When to use**: Critical bug, need to disable feature entirely.

```python
# In fusion/modules/rl/gymnasium_envs/__init__.py

# Set to True to force legacy env for all calls
_FORCE_LEGACY_ENV = False  # Change to True for global rollback

def _resolve_env_type(env_type: str | None) -> str:
    if _FORCE_LEGACY_ENV:
        return EnvType.LEGACY
    # ... rest of resolution logic
```

### 2. Rollback Decision Tree

```
Issue Detected
     │
     ├── Critical (crash, data loss)?
     │      │
     │      └── Yes ──> Immediate Rollback (env var)
     │                  + Open critical issue
     │
     ├── Performance regression?
     │      │
     │      ├── >20% slower ──> Code-level rollback
     │      │                   + Profile and optimize
     │      │
     │      └── <20% slower ──> Document in differences
     │                          + Continue monitoring
     │
     ├── Different results?
     │      │
     │      ├── Outside tolerance ──> Investigate
     │      │      │
     │      │      ├── Bug ──> Rollback + Fix
     │      │      └── Intentional ──> Document
     │      │
     │      └── Within tolerance ──> Document
     │
     └── Other issue?
            │
            └── Investigate before rollback
```

### 3. Issue Response Procedures

#### 3.1 Critical Issue Response

1. **Immediate**: Set `USE_UNIFIED_ENV=0` in production/CI
2. **Within 1 hour**: Open GitHub issue with "critical" label
3. **Within 24 hours**: Root cause analysis
4. **Resolution**: Fix or document as known limitation

#### 3.2 Performance Issue Response

1. **Profile** both environments to identify bottleneck
2. **Document** performance difference
3. **Optimize** if possible, or document as trade-off
4. **Rollback** if performance is unacceptable

#### 3.3 Behavioral Difference Response

1. **Verify** difference with parity tests
2. **Determine** if intentional or bug
3. **Document** in `rl_differences.md` if intentional
4. **Fix** if bug, then re-run parity tests

### 4. Rollback Testing

Before rollback is needed, verify rollback works:

```python
# tests/rl/test_rollback.py

import os
from unittest.mock import patch


class TestRollbackProcedures:
    """Verify rollback mechanisms work correctly."""

    def test_env_var_forces_legacy(self, config):
        """USE_UNIFIED_ENV=0 should force legacy env."""
        with patch.dict(os.environ, {"USE_UNIFIED_ENV": "0"}):
            env = create_sim_env(config)
            from fusion.modules.rl.gymnasium_envs import SimEnv
            assert isinstance(env, SimEnv)

    def test_explicit_legacy_overrides_env_var(self, config):
        """Explicit legacy should work even with USE_UNIFIED_ENV=1."""
        with patch.dict(os.environ, {"USE_UNIFIED_ENV": "1"}):
            env = create_sim_env(config, env_type="legacy")
            from fusion.modules.rl.gymnasium_envs import SimEnv
            assert isinstance(env, SimEnv)

    def test_legacy_env_still_functional(self, config):
        """Legacy env should still work correctly after rollback."""
        with patch.dict(os.environ, {"USE_UNIFIED_ENV": "0"}):
            env = create_sim_env(config)
            obs, _ = env.reset(seed=42)
            _, reward, _, _, _ = env.step(0)
            assert obs is not None
            assert reward != 0
```

### 5. Communication Template

#### Issue Notification

```markdown
## RL Environment Issue Report

**Severity**: Critical / High / Medium / Low
**Environment**: UnifiedSimEnv v4.0.0
**Rollback Status**: Applied / Not needed

### Description
[Brief description of the issue]

### Impact
- [ ] Training affected
- [ ] Evaluation affected
- [ ] Production affected

### Workaround
```bash
export USE_UNIFIED_ENV=0
```

### Next Steps
1. [Step 1]
2. [Step 2]

### ETA for Fix
[Estimate or "investigating"]
```

#### Resolution Notification

```markdown
## RL Environment Issue Resolved

**Issue**: [Reference to original issue]
**Resolution**: Fixed / Documented as expected behavior
**Version**: v4.0.1

### Changes
- [List of changes]

### Action Required
- [ ] Update environment variable (if previously set)
- [ ] Retrain models (if needed)
- [ ] No action required

### Notes
[Any additional context]
```

### 6. Monitoring for Rollback Triggers

Set up monitoring to detect issues early:

```python
# In training scripts, add logging
import logging

logger = logging.getLogger(__name__)


def monitor_env_metrics(env, step, reward, info):
    """Log metrics for monitoring."""
    if step % 1000 == 0:
        logger.info(f"Step {step}: reward={reward:.2f}")

    # Alert on unexpected conditions
    if "action_mask" in info:
        valid_actions = info["action_mask"].sum()
        if valid_actions == 0:
            logger.warning(f"Step {step}: No valid actions available")
```

### 7. Documentation Updates for Rollback

Add to user-facing documentation:

```markdown
## Troubleshooting

### Reverting to Legacy RL Environment

If you encounter issues with `UnifiedSimEnv`, you can revert to
the legacy `GeneralSimEnv`:

1. **Quick revert**: Set environment variable
   ```bash
   export USE_UNIFIED_ENV=0
   ```

2. **Per-script revert**: Use factory function
   ```python
   env = create_sim_env(config, env_type="legacy")
   ```

3. **Report the issue**: Open a GitHub issue with:
   - Description of the problem
   - Steps to reproduce
   - Expected vs actual behavior

### Known Limitations

See [RL Environment Differences](rl_differences.md) for expected
differences between legacy and unified environments.
```

### 8. Rollback Verification Checklist

After executing rollback:

- [ ] Training scripts run without errors
- [ ] Legacy environment is used (verify via logging)
- [ ] Existing models can be loaded
- [ ] Metrics collection works
- [ ] CI/CD pipelines pass

### 9. Recovery from Rollback

After issue is fixed:

1. **Test fix** in isolated environment
2. **Run parity tests** to verify no regressions
3. **Update documentation** if behavior changed
4. **Communicate** resolution to affected users
5. **Remove rollback** configuration
6. **Monitor** for recurrence

## Verification

- [ ] All rollback procedures documented
- [ ] Decision tree covers common scenarios
- [ ] Communication templates ready
- [ ] Rollback tests implemented
- [ ] Monitoring recommendations provided
- [ ] Recovery procedure defined

## Phase 4 Completion

With P4.4.d complete, all Phase 4 micro-tasks are defined. The phase is ready for implementation.

### Phase 4 Exit Criteria Summary

- [ ] `RLSimulationAdapter` implemented with tests
- [ ] `UnifiedSimEnv` passes gymnasium checker
- [ ] Factory function with feature flags works
- [ ] Deprecation warnings on `GeneralSimEnv`
- [ ] Parity tests pass (blocking within 5%)
- [ ] Differences documented
- [ ] Rollback procedures tested
- [ ] run_comparison.py passes
- [ ] All code passes ruff and mypy
