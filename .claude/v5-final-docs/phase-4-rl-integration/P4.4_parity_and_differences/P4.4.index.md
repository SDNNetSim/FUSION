# P4.4 Index - Parity Validation & Differences Documentation

**Phase:** 4 - RL Integration
**Sub-phase:** P4.4
**Version:** v5.1 (Gap Analysis Complete)
**Status:** Ready for Implementation
**Last Updated:** 2024

## Goals

Validate that `UnifiedSimEnv` produces results comparable to `GeneralSimEnv`, document any intentional differences, and establish a rollback procedure if issues are found.

### Core Principle: Verified Migration

Before fully deprecating `GeneralSimEnv`, we must verify that `UnifiedSimEnv` produces equivalent or better results. Any differences must be intentional, documented, and justified.

## Key Deliverables

1. **Parity test suite** in `fusion/tests/rl/test_rl_parity.py`
2. **Comparison scripts** for blocking probability and rewards
3. **Differences documentation** at `docs/migration/rl_differences.md`
4. **Rollback procedure** documentation
5. **Metrics comparison report** template

## Constraints

1. **Quantitative Validation**: Blocking probability within 5%
2. **Deterministic Comparison**: Same seed = same traffic sequence
3. **Documented Differences**: All variations explained
4. **Safe Rollback**: Quick revert if issues found
5. **Policy Compatibility**: Address trained model implications

## Dependencies

- **P4.1**: `RLSimulationAdapter`
- **P4.2**: `UnifiedSimEnv`
- **P4.3**: Factory function and migration infrastructure
- Legacy: `GeneralSimEnv`

## Micro-Tasks

| ID | File | Type | Description |
|----|------|------|-------------|
| P4.4.a | `P4.4.a_design_parity_tests.md` | design | Design parity test strategy |
| P4.4.b | `P4.4.b_verification_plan_parity.md` | verification-plan | Define parity test implementation |
| P4.4.c | `P4.4.c_documentation_differences.md` | documentation | Plan differences documentation |
| P4.4.d | `P4.4.d_rollback_plan.md` | migration-plan | Define rollback procedures |
| P4.4.e | `P4.4.e_per_algorithm_differences.md` | documentation | Per-algorithm differences matrix (Gap-filling) |

## Shared Context Files

- `P4.4.shared_context_parity_metrics.md` - Metrics and tolerances for parity

## Exit Criteria

### Core
- [ ] Parity tests pass (blocking within 5%)
- [ ] Deterministic comparison succeeds
- [ ] All differences documented
- [ ] Rollback procedure tested
- [ ] Migration guide updated with differences
- [ ] run_comparison.py passes

### Gap-Filling (P4.4.e)
- [ ] PPO differences documented (observation space, action masking, expected improvement)
- [ ] A2C differences documented
- [ ] DQN/QR-DQN differences documented (custom masking impact)
- [ ] Q-Learning differences documented (state discretization impact)
- [ ] Bandit differences documented (arm masking impact)
- [ ] BC/IQL compatibility verified with adapter
- [ ] Parity testing protocol defined for each algorithm
- [ ] Migration recommendations per algorithm

## File Inventory

```
P4.4_parity_and_differences/
├── P4.4.index.md                              # This file
├── P4.4.shared_context_parity_metrics.md      # Shared context
├── P4.4.a_design_parity_tests.md              # Design task
├── P4.4.b_verification_plan_parity.md         # Verification
├── P4.4.c_documentation_differences.md        # Documentation
├── P4.4.d_rollback_plan.md                    # Migration plan
└── P4.4.e_per_algorithm_differences.md        # Gap-filling (NEW)
```

**Total:** 7 files (1 index, 1 shared context, 5 micro-tasks)

## Implementation Order

1. **P4.4.a** - Design parity test strategy
2. **P4.4.b** - Define parity test implementation
3. **P4.4.c** - Document general differences
4. **P4.4.d** - Define rollback procedures
5. **P4.4.e** - Document per-algorithm differences

## Phase 4 Completion

After P4.4 completion, Phase 4 is complete. Next steps:
- Monitor for regressions
- Gather feedback from users
- Plan for Phase 5/6 (legacy removal)
