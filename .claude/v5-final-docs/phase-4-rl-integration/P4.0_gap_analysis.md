# Phase 4 Gap Analysis - RL Integration

**Date:** 2024
**Status:** Analysis Complete
**Purpose:** Document gaps between V5 Phase 4 documentation and actual codebase requirements

## Executive Summary

The Phase 4 documentation partially covers the RL integration but has significant gaps related to:
1. **Multi-agent architecture** (path, core, spectrum agents)
2. **Graph-based observations** for GNN feature extractors
3. **Offline RL policies** (BC, IQL) and their state format
4. **Disaster-aware features** used in survivability experiments
5. **Algorithm-specific migration** paths for all supported algorithms
6. **RLZoo3 integration** and hyperparameter management

## Detailed Gap Analysis

### P4.1 RL Adapter Gaps

#### Gap 1.1: Missing Disaster-Aware Features

**Current V5 docs specify PathOption with:**
- path_index, path, weight_km, num_hops, modulation, slots_needed
- congestion, available_slots, is_feasible, spectrum_start/end, core_index, band

**Legacy BC/IQL policies expect:**
```python
# Request features
state["src"]
state["dst"]
state["slots_needed"]
state["est_remaining_time"]
state["is_disaster"]  # MISSING FROM V5 DOCS

# Path features (per path)
path_features["path_hops"]
path_features["min_residual_slots"]
path_features["frag_indicator"]  # MISSING FROM V5 DOCS
path_features["failure_mask"]  # MISSING FROM V5 DOCS
path_features["dist_to_disaster_centroid"]  # MISSING FROM V5 DOCS
```

**Action Required:** Add disaster-aware and fragmentation features to PathOption design.

#### Gap 1.2: Multi-Agent Support

**Current V5 docs assume:** Single path-selection agent
**Actual codebase has:**
- `PathAgent` - path selection
- `CoreAgent` - core selection (multi-core fibers)
- `SpectrumAgent` - spectrum slot selection

**Action Required:** Document adapter support for multi-agent scenarios.

#### Gap 1.3: Offline RL Policy Compatibility

**BC/IQL policies have specific state format requirements:**
- Flattened tensor format for model input
- Different feature ordering than PathOption

**Action Required:** Document state-to-tensor conversion for offline policy compatibility.

---

### P4.2 Unified Env Gaps

#### Gap 2.1: Missing Graph Observations

**Current V5 docs specify observation space:**
- source, destination, holding_time, slots_needed
- path_lengths, congestion, available_slots, is_feasible

**Legacy env supports graph observations (obs_*_graph):**
```python
{
    "x": spaces.Box(...),  # Node features
    "edge_index": spaces.Box(...),  # Edge connectivity
    "edge_attr": spaces.Box(...),  # Edge attributes
    "path_masks": spaces.Box(...),  # Path-to-edge mappings
}
```

**Used by:** Graphormer, PathGNN, PathGNNCached feature extractors

**Action Required:** Add optional graph observation support to UnifiedSimEnv.

#### Gap 2.2: Missing request_bandwidth Feature

**Legacy obs_2 through obs_8 include:**
```python
"request_bandwidth": spaces.MultiBinary(len(bw_set))
```

**V5 docs omit this feature.**

**Action Required:** Add request_bandwidth to observation space design.

#### Gap 2.3: Configurable Observation Space

**Legacy env supports 8 observation configurations (obs_1 through obs_8):**
- obs_1: Basic (source, destination)
- obs_8: Full (all features including is_feasible)

**V5 docs assume single fixed observation space.**

**Action Required:** Document configurable observation space selection.

#### Gap 2.4: Fragmentation Tracking

**Legacy env has FragmentationTracker class providing:**
```python
{
    "fragmentation": np.array([core_frag]),
    "path_frag": np.array([path_frag]),
}
```

**V5 docs do not include fragmentation in observation space.**

**Action Required:** Document optional fragmentation observation integration.

---

### P4.3 Migration Gaps

#### Gap 3.1: Algorithm-Specific Migration Paths

**Supported algorithms not explicitly mapped:**

| Algorithm | Type | Current Location | Migration Notes |
|-----------|------|------------------|-----------------|
| PPO | SB3 Online | `algorithms/ppo.py` | Standard SB3 |
| A2C | SB3 Online | `algorithms/a2c.py` | Standard SB3 |
| DQN | SB3 Online | `algorithms/dqn.py` | Standard SB3 |
| QR-DQN | SB3 Online | `algorithms/qr_dqn.py` | sb3-contrib |
| Q-Learning | Tabular | `algorithms/q_learning.py` | Custom impl |
| Bandits | MAB | `algorithms/bandits.py` | Custom impl |
| BC | Offline | `policies/bc_policy.py` | PyTorch |
| IQL | Offline | `policies/iql_policy.py` | PyTorch |

**Action Required:** Document migration path for each algorithm type.

#### Gap 3.2: RLZoo3 Hyperparameter Management

**Legacy uses:**
- `sb3_scripts/yml/*.yml` config files
- `register_env.py` to copy configs to RLZoo3

**V5 docs do not address RLZoo3 integration.**

**Action Required:** Document RLZoo3 hyperparameter file migration.

#### Gap 3.3: Training Callbacks

**Legacy callbacks:**
- `EpisodicRewardCallback` - Per-episode reward logging
- `LearnRateEntCallback` - Learning rate/entropy tracking

**V5 docs assume standard SB3 callbacks.**

**Action Required:** Document callback migration/compatibility.

#### Gap 3.4: Multi-Agent Experiment Mapping

**Legacy experiments may use:**
- Path-only agent
- Core-only agent
- Path + Core combined

**V5 docs assume path-selection-only scenarios.**

**Action Required:** Document multi-agent experiment migration.

---

### P4.4 Parity/Differences Gaps

#### Gap 4.1: Algorithm-Specific Differences

**Need per-algorithm documentation for:**

| Algorithm | Key Differences | Retraining Required |
|-----------|-----------------|---------------------|
| PPO | Action masking integration | Recommended |
| A2C | Action masking integration | Recommended |
| DQN | Discrete action handling | Recommended |
| QR-DQN | Distributional RL changes | Required |
| Q-Learning | State discretization | Required |
| Bandits | Arm definition changes | Required |
| BC | State format conversion | Adapter needed |
| IQL | State format conversion | Adapter needed |

**Action Required:** Create algorithm-specific migration guides.

#### Gap 4.2: Graph Feature Extractor Compatibility

**GNN-based extractors require:**
- Consistent graph structure
- Edge attribute format
- Path mask generation

**V5 docs do not address GNN compatibility.**

**Action Required:** Document graph observation parity.

#### Gap 4.3: Disaster-Aware Feature Parity

**Survivability experiments use:**
- `is_disaster` flag
- `failure_mask` per path
- `dist_to_disaster_centroid`

**These require specific handling in unified env.**

**Action Required:** Document disaster feature parity requirements.

---

## Resolution Plan

### Phase 4.1 Additions
- [ ] P4.1.f: Offline RL Policy Compatibility
- [ ] P4.1.g: Disaster-Aware Feature Support
- [ ] P4.1.h: Multi-Agent Adapter Extensions

### Phase 4.2 Additions
- [ ] P4.2.f: Graph Observation Support
- [ ] P4.2.g: Configurable Observation Space
- [ ] P4.2.h: Fragmentation Tracking Integration

### Phase 4.3 Additions
- [ ] P4.3.e: Algorithm-Specific Migration Guides
- [ ] P4.3.f: RLZoo3 Integration Migration
- [ ] P4.3.g: Training Callbacks Migration
- [ ] P4.3.h: Multi-Agent Experiment Mapping

### Phase 4.4 Additions
- [ ] P4.4.e: Per-Algorithm Differences Matrix
- [ ] P4.4.f: Graph Feature Extractor Parity
- [ ] P4.4.g: Disaster Feature Parity Guide

---

## Impact Assessment

### High Priority (Blocks Migration)
1. Graph observation support (GNN users cannot migrate without it)
2. Offline RL state format (BC/IQL policies incompatible)
3. Algorithm-specific migration paths (users need guidance)

### Medium Priority (Degrades Experience)
1. Configurable observation space (users locked to one config)
2. Fragmentation tracking (advanced users need it)
3. Training callbacks (monitoring limitations)

### Low Priority (Future Enhancement)
1. Multi-agent support (few experiments use it)
2. Disaster features (specific to survivability experiments)
3. RLZoo3 integration (power users only)

---

## Next Steps

1. Create gap-filling documentation files (P4.1.f through P4.4.g)
2. Update phase overview with new micro-tasks
3. Verify all legacy paths have migration documentation
4. Add verification tests for each gap area
