# P4.1 Index - RLSimulationAdapter Scaffolding

**Phase:** 4 - RL Integration
**Sub-phase:** P4.1
**Version:** v5.1 (Gap Analysis Complete)
**Status:** Ready for Implementation
**Last Updated:** 2024

## Goals

Create the `RLSimulationAdapter` class and supporting types that allow RL agents to interact with the V4 simulation stack without duplicating any routing, spectrum, or allocation logic.

### Core Principle: No Forked Simulator

The adapter must use the **exact same pipeline instances** as the orchestrator. This is verified by identity checks (`adapter.routing is orchestrator.routing`), not equality checks.

## Key Deliverables

1. **`fusion/rl/__init__.py`** - Package definition with public exports
2. **`fusion/rl/adapter.py`** - `RLSimulationAdapter` class and `PathOption` dataclass
3. **`fusion/rl/observation.py`** - Observation building utilities (optional, can be in adapter)
4. **`fusion/rl/reward.py`** - Reward computation utilities (optional, can be in adapter)

## Constraints

1. **Shared Pipelines**: Adapter holds references (not copies) to orchestrator pipelines
2. **Stateless Design**: Adapter never stores `NetworkState`; receives it per-call
3. **Read-Only Queries**: `get_path_options()` does NOT mutate network state
4. **Write-Through Orchestrator**: `apply_action()` goes through `SDNOrchestrator.handle_arrival()`
5. **No New Algorithms**: Uses existing routing/spectrum/grooming logic from pipelines

## Dependencies

- **Phase 1**: `SimulationConfig`, `Request`, `Lightpath`, result types
- **Phase 2**: `NetworkState` with pipeline protocol compatibility
- **Phase 3**: `SDNOrchestrator`, `PipelineFactory`, `RoutingPipeline`, `SpectrumPipeline`

## Micro-Tasks

| ID | File | Type | Description |
|----|------|------|-------------|
| P4.1.a | `P4.1.a_context_extraction_legacy_rl.md` | context-extraction | Map how legacy RL calls mock_handle_arrival and obtains paths/feasibility |
| P4.1.b | `P4.1.b_design_pathoption.md` | design | Design PathOption dataclass for candidate path representation |
| P4.1.c | `P4.1.c_design_adapter_api.md` | design | Design RLSimulationAdapter public API |
| P4.1.d | `P4.1.d_wiring_plan_pipelines.md` | wiring-plan | Plan how adapter references orchestrator pipelines |
| P4.1.e | `P4.1.e_verification_plan.md` | verification-plan | Define unit tests for adapter behavior |
| P4.1.f | `P4.1.f_offline_rl_compatibility.md` | design | Offline RL (BC, IQL) state format compatibility (Gap-filling) |

## Shared Context Files

- `P4.1.shared_context_legacy_rl_paths.md` - Extracted info about legacy RL data flows

## Exit Criteria

### Core
- [ ] `PathOption` dataclass defined with all required fields
- [ ] `RLSimulationAdapter` class created with `get_path_options()` and `apply_action()`
- [ ] Adapter uses same pipeline instances as orchestrator (identity check passes)
- [ ] All unit tests pass with >= 80% coverage for `fusion/rl/`
- [ ] Code passes ruff and mypy

### Gap-Filling (P4.1.f)
- [ ] `build_offline_state()` method supports BC/IQL state format
- [ ] `DisasterState` dataclass captures disaster information
- [ ] `OfflinePolicyAdapter` bridges offline policies with UnifiedSimEnv
- [ ] Extended `PathOption` includes disaster-aware fields

## File Inventory

```
P4.1_rl_adapter/
├── P4.1.index.md                              # This file
├── P4.1.shared_context_legacy_rl_paths.md     # Shared context
├── P4.1.a_context_extraction_legacy_rl.md     # Context extraction
├── P4.1.b_design_pathoption.md                # Design task
├── P4.1.c_design_adapter_api.md               # Design task
├── P4.1.d_wiring_plan_pipelines.md            # Wiring plan
├── P4.1.e_verification_plan.md                # Verification
└── P4.1.f_offline_rl_compatibility.md         # Gap-filling (NEW)
```

**Total:** 8 files (1 index, 1 shared context, 6 micro-tasks)

## Implementation Order

1. **P4.1.a** - Extract legacy RL patterns and data flows
2. **P4.1.b** - Design PathOption dataclass
3. **P4.1.c** - Design RLSimulationAdapter API
4. **P4.1.d** - Plan pipeline wiring
5. **P4.1.e** - Define verification tests
6. **P4.1.f** - Add offline RL compatibility (BC/IQL, DisasterState)

## Next Sub-Phase

After P4.1 completion, proceed to **P4.2: UnifiedSimEnv Wiring**.
