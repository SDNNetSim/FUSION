# P4.3 Index - Migrate Existing RL Experiments

**Phase:** 4 - RL Integration
**Sub-phase:** P4.3
**Version:** v5.1 (Gap Analysis Complete)
**Status:** Ready for Implementation
**Last Updated:** 2024

## Goals

Migrate existing RL training scripts and experiments to use `UnifiedSimEnv` while maintaining backward compatibility with `GeneralSimEnv`. This enables gradual adoption and safe rollback.

### Core Principle: Non-Breaking Migration

All existing RL experiments must continue to work unchanged. The migration is opt-in via feature flags, with clear deprecation warnings guiding users to the new environment.

## Key Deliverables

1. **Factory function** in `fusion/modules/rl/gymnasium_envs/__init__.py`
2. **Feature flag** system for environment selection
3. **Deprecation warnings** on `GeneralSimEnv`
4. **Updated training scripts** with unified env support
5. **Migration guide** documentation

## Constraints

1. **Backward Compatible**: Existing scripts work without changes
2. **Opt-In Migration**: New env requires explicit flag
3. **Clear Deprecation**: Warnings point to migration path
4. **SB3 Compatible**: Both envs work with same training code
5. **Rollback Ready**: Easy switch back to legacy env

## Dependencies

- **P4.1**: `RLSimulationAdapter`
- **P4.2**: `UnifiedSimEnv`, `ActionMaskWrapper`
- Legacy: `fusion/modules/rl/gymnasium_envs/general_sim_env.py`

## Micro-Tasks

| ID | File | Type | Description |
|----|------|------|-------------|
| P4.3.a | `P4.3.a_context_extraction_experiments.md` | context-extraction | Document existing RL scripts and experiments |
| P4.3.b | `P4.3.b_migration_plan_factory.md` | migration-plan | Plan factory function and feature flags |
| P4.3.c | `P4.3.c_deprecation_plan.md` | migration-plan | Plan deprecation warnings and migration guide |
| P4.3.d | `P4.3.d_verification_plan.md` | verification-plan | Define tests for migration |
| P4.3.e | `P4.3.e_algorithm_migration_guide.md` | migration-guide | Algorithm-specific migration paths (Gap-filling) |

## Shared Context Files

- `P4.3.shared_context_training_scripts.md` - Summary of existing training scripts

## Exit Criteria

### Core
- [ ] Factory function creates correct environment based on flag
- [ ] `GeneralSimEnv` shows deprecation warning
- [ ] Legacy experiments run unchanged (with warning)
- [ ] New experiments can use `UnifiedSimEnv`
- [ ] SB3 training works with both environments
- [ ] All tests pass
- [ ] Migration guide complete

### Gap-Filling (P4.3.e)
- [ ] PPO migration documented with MaskablePPO integration
- [ ] A2C migration documented with action masking approach
- [ ] DQN/QR-DQN migration documented with custom masking
- [ ] Q-Learning migration documented with state discretizer
- [ ] Bandit migration documented with arm masking
- [ ] BC/IQL migration documented with OfflinePolicyAdapter
- [ ] Common utilities provided (ActionMaskingWrapper, StateDiscretizer)
- [ ] All algorithm examples tested and working

## File Inventory

```
P4.3_migrate_experiments/
├── P4.3.index.md                              # This file
├── P4.3.shared_context_training_scripts.md    # Shared context
├── P4.3.a_context_extraction_experiments.md   # Context extraction
├── P4.3.b_migration_plan_factory.md           # Migration plan
├── P4.3.c_deprecation_plan.md                 # Migration plan
├── P4.3.d_verification_plan.md                # Verification
└── P4.3.e_algorithm_migration_guide.md        # Gap-filling (NEW)
```

**Total:** 7 files (1 index, 1 shared context, 5 micro-tasks)

## Implementation Order

1. **P4.3.a** - Extract existing experiment patterns
2. **P4.3.b** - Design factory function and feature flags
3. **P4.3.c** - Plan deprecation warnings
4. **P4.3.d** - Define verification tests
5. **P4.3.e** - Write algorithm-specific migration guides

## Next Sub-Phase

After P4.3 completion, proceed to **P4.4: Parity Validation & Differences Documentation**.
