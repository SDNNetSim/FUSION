# Task ID: P4.3.c - Deprecation Plan: Warnings and Migration Guide

**Sub-phase:** P4.3
**Scope:** Phase 4 - RL Integration only
**Task type:** migration-plan

## Purpose

Plan the deprecation of `GeneralSimEnv` in favor of `UnifiedSimEnv`, including warning messages, migration guide content, and rollback procedures.

## Context to load before running this task

- `.claude/v5-final-docs/phase-4-rl-integration/P4.3_migrate_experiments/P4.3.b_migration_plan_factory.md`
- `fusion/modules/rl/gymnasium_envs/general_sim_env.py`

## Outputs

### 1. Deprecation Warning Implementation

Add to `fusion/modules/rl/gymnasium_envs/general_sim_env.py`:

```python
import warnings


class SimEnv(gym.Env):
    """Legacy RL environment.

    .. deprecated:: 4.0
        SimEnv (GeneralSimEnv) is deprecated and will be removed in v5.0.
        Use UnifiedSimEnv instead for better accuracy and unified code paths.
        See migration guide: docs/migration/rl_to_unified_env.md
    """

    def __init__(
        self,
        render_mode=None,
        custom_callback=None,
        sim_dict=None,
        **kwargs
    ):
        warnings.warn(
            "SimEnv (GeneralSimEnv) is deprecated and will be removed in v5.0. "
            "Use UnifiedSimEnv instead via:\n"
            "  from fusion.rl.environments import UnifiedSimEnv\n"
            "  env = UnifiedSimEnv(config)\n"
            "Or use the factory function:\n"
            "  from fusion.modules.rl.gymnasium_envs import create_sim_env\n"
            "  env = create_sim_env(config, env_type='unified')\n"
            "See: docs/migration/rl_to_unified_env.md",
            DeprecationWarning,
            stacklevel=2,
        )

        # ... rest of __init__ ...
```

### 2. Warning Suppression for Intentional Use

For users who intentionally use legacy env:

```python
import warnings
from fusion.modules.rl.gymnasium_envs import SimEnv

# Suppress if intentional
with warnings.catch_warnings():
    warnings.filterwarnings("ignore", category=DeprecationWarning)
    env = SimEnv(sim_dict=config)
```

Or via environment variable:

```python
# In SimEnv.__init__
if not os.environ.get("SUPPRESS_SIMENV_DEPRECATION"):
    warnings.warn(...)
```

### 3. Migration Guide Content

Create `docs/migration/rl_to_unified_env.md`:

```markdown
# Migrating from GeneralSimEnv to UnifiedSimEnv

## Overview

`GeneralSimEnv` (also known as `SimEnv`) is deprecated in favor of
`UnifiedSimEnv`. The new environment uses the V4 simulation stack,
providing:

- More accurate feasibility checks (real spectrum pipeline)
- Unified code paths with non-RL simulation
- Proper action masking via info dict
- Better reproducibility guarantees

## Quick Migration

### Option 1: Environment Variable

Set environment variable before running:

```bash
export USE_UNIFIED_ENV=1
python train.py
```

### Option 2: Factory Function

Use the factory function with explicit type:

```python
# Before
from fusion.modules.rl.gymnasium_envs import SimEnv
env = SimEnv(sim_dict=config)

# After
from fusion.modules.rl.gymnasium_envs import create_sim_env
env = create_sim_env(config, env_type="unified")
```

### Option 3: Direct Import

Import and use `UnifiedSimEnv` directly:

```python
# Before
from fusion.modules.rl.gymnasium_envs import SimEnv
env = SimEnv(sim_dict=config)

# After
from fusion.rl.environments import UnifiedSimEnv
env = UnifiedSimEnv(config)
```

## Configuration Changes

### Config Format

`UnifiedSimEnv` uses `SimulationConfig` instead of dict:

```python
# Before (dict)
config = {
    "k_paths": 3,
    "spectral_slots": 320,
    # ...
}
env = SimEnv(sim_dict={"s1": config})

# After (SimulationConfig)
from fusion.core.config import SimulationConfig
config = SimulationConfig.from_file("config.ini")
env = UnifiedSimEnv(config)
```

### Observation Space

The observation spaces are compatible but may have minor differences:

| Key | GeneralSimEnv | UnifiedSimEnv |
|-----|---------------|---------------|
| `source` | Same | Same |
| `destination` | Same | Same |
| `holding_time` | Same | Same |
| `slots_needed` | Same | Same |
| `path_lengths` | Same | Same |
| `paths_cong` | `paths_cong` | `congestion` (renamed) |
| `available_slots` | Same | Same |
| `is_feasible` | Not present | Added |

### Action Masking

`UnifiedSimEnv` provides action masks in the info dict:

```python
# GeneralSimEnv - no action mask
obs, info = env.reset()  # info = {}

# UnifiedSimEnv - action mask included
obs, info = env.reset()  # info = {"action_mask": array([True, False, True])}
```

## Training with MaskablePPO

`UnifiedSimEnv` supports SB3 MaskablePPO out of the box:

```python
from sb3_contrib import MaskablePPO
from fusion.rl.environments import UnifiedSimEnv, ActionMaskWrapper

env = UnifiedSimEnv(config)
env = ActionMaskWrapper(env)

model = MaskablePPO("MultiInputPolicy", env)
model.learn(total_timesteps=100_000)
```

## Model Compatibility

Models trained with `GeneralSimEnv` may not work directly with
`UnifiedSimEnv` due to observation space differences. Options:

1. **Retrain**: Train new models with `UnifiedSimEnv`
2. **Adapter**: Create observation adapter (if differences are minor)
3. **Continue with legacy**: Keep using `GeneralSimEnv` temporarily

## Rollback Procedure

If you encounter issues with `UnifiedSimEnv`:

1. Set environment variable:
   ```bash
   export USE_UNIFIED_ENV=0
   ```

2. Or use factory explicitly:
   ```python
   env = create_sim_env(config, env_type="legacy")
   ```

3. Report the issue at: https://github.com/[repo]/issues

## Timeline

- **v4.0**: UnifiedSimEnv introduced, GeneralSimEnv deprecated
- **v4.x**: Both environments available, migration period
- **v5.0**: GeneralSimEnv removed, only UnifiedSimEnv available

## Frequently Asked Questions

### Q: Why the change?

GeneralSimEnv duplicates simulation logic via `mock_handle_arrival()`,
which can diverge from the actual simulation. UnifiedSimEnv uses the
same pipelines, ensuring consistent behavior.

### Q: Will my trained models work?

If observation spaces match, yes. If there are differences, you may
need to retrain. See "Model Compatibility" above.

### Q: Is UnifiedSimEnv slower?

It uses real pipelines, which may have different performance
characteristics. In most cases, the difference is negligible.
If performance is critical, benchmark both.

### Q: Can I use both in the same project?

Yes, during the migration period both are available. Use the factory
function with explicit `env_type` to control which is used.
```

### 4. Deprecation Timeline

| Version | Status |
|---------|--------|
| v4.0 | UnifiedSimEnv added, deprecation warning on SimEnv |
| v4.1+ | Continue deprecation period |
| v5.0 | Remove GeneralSimEnv entirely |

### 5. Rollback Procedure

Document in migration guide and code:

```python
# Quick rollback options:

# 1. Environment variable
os.environ["USE_UNIFIED_ENV"] = "0"

# 2. Factory parameter
env = create_sim_env(config, env_type="legacy")

# 3. Direct import (still works during deprecation)
from fusion.modules.rl.gymnasium_envs import SimEnv
env = SimEnv(sim_dict=config)
```

### 6. Logging for Support

Add logging to help with support:

```python
import logging

logger = logging.getLogger(__name__)


class SimEnv(gym.Env):
    def __init__(self, ...):
        logger.info(
            "Creating legacy SimEnv. Consider migrating to UnifiedSimEnv. "
            "See docs/migration/rl_to_unified_env.md"
        )
        # ...
```

### 7. Changelog Entry

```markdown
## [4.0.0] - YYYY-MM-DD

### Added
- `UnifiedSimEnv`: New RL environment using V4 simulation stack
- `RLSimulationAdapter`: Adapter between RL and simulation pipelines
- `ActionMaskWrapper`: SB3-compatible action masking wrapper
- `create_sim_env()`: Factory function for environment creation
- Environment variable `USE_UNIFIED_ENV` for migration control

### Deprecated
- `GeneralSimEnv` (SimEnv): Use `UnifiedSimEnv` instead
  - Will be removed in v5.0
  - See migration guide: docs/migration/rl_to_unified_env.md

### Changed
- Default RL environment remains `GeneralSimEnv` during migration period
- Training scripts updated to support both environments
```

## Verification

- [ ] Deprecation warning added to SimEnv
- [ ] Warning includes migration instructions
- [ ] Suppression mechanism works
- [ ] Migration guide complete
- [ ] Rollback procedure documented
- [ ] Changelog updated

## Next Task

Proceed to **P4.3.d** to define verification tests for migration.
