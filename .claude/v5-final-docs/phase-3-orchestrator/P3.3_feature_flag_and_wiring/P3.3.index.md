# P3.3 Feature Flag & Simulation Wiring - Index

## Sub-phase Overview

**Goal**: Add feature flag to switch between legacy SDNController and new SDNOrchestrator paths in the simulation engine.

**Files Modified**:
- `fusion/core/simulation.py`

**Dependencies**:
- P3.1 complete (PipelineFactory)
- P3.2 complete (SDNOrchestrator)
- Phase 2 complete (NetworkState)

## Objectives

1. Add `use_orchestrator` feature flag to configuration
2. Wire SDNOrchestrator into SimulationEngine
3. Route arrival/release events through appropriate path
4. Preserve legacy SDNController path as default
5. Ensure both paths produce equivalent stats

## Constraints

- **Default is legacy path**: `use_orchestrator=False` by default
- **No breaking changes**: Legacy path must remain fully functional
- **Clean separation**: Both paths coexist without interference
- **Equivalent stats**: Both paths must update stats consistently
- All code must pass `mypy --strict` and `ruff check`

## Micro-tasks

Execute in alphabetical order:

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P3.3.a | `P3.3.a_map_sdn_controller_calls.md` | context-extraction | Map all SDNController call sites |
| P3.3.b | `P3.3.b_design_feature_flag.md` | design | Design feature flag mechanism |
| P3.3.c | `P3.3.c_wire_orchestrator.md` | refactor-plan | Wire orchestrator into simulation |
| P3.3.d | `P3.3.d_verify_wiring.md` | verification-plan | Verify both paths work |

## Shared Context

- `P3.3.shared_context_simulation_entrypoints.md` - Current simulation structure

## Feature Flag Design

```python
# In SimulationEngine.__init__
self._use_orchestrator = engine_props.get('use_orchestrator', False)

if self._use_orchestrator:
    # New path: orchestrator with pipelines
    self._config = SimulationConfig.from_engine_props(engine_props)
    self._network_state = NetworkState(self.topology, self._config)
    self._orchestrator = PipelineFactory.create_orchestrator(self._config)
else:
    # Old path: existing SDNController
    self.sdn_obj = SDNController(engine_props)
```

## Dual Path Structure

```
SimulationEngine
    |
    +-- _use_orchestrator = False (default)
    |       |
    |       +-- self.sdn_obj = SDNController(...)
    |       +-- handle_arrival -> sdn_obj.handle_event('arrival')
    |       +-- handle_release -> sdn_obj.handle_event('release')
    |       +-- stats via _update_stats_from_sdn_props()
    |
    +-- _use_orchestrator = True
            |
            +-- self._orchestrator = SDNOrchestrator(...)
            +-- self._network_state = NetworkState(...)
            +-- handle_arrival -> _orchestrator.handle_arrival(request, state)
            +-- handle_release -> _orchestrator.handle_release(request, state)
            +-- stats via _update_stats_from_result()
```

## Event Routing

### handle_arrival

```python
def handle_arrival(self, current_time: tuple[int, float]) -> None:
    request_dict = self.reqs_dict[current_time]

    if self._use_orchestrator:
        # New path
        request = Request.from_legacy_dict(current_time, request_dict, self._config)
        result = self._orchestrator.handle_arrival(request, self._network_state)
        self._requests[current_time] = request  # Store for release
        self._update_stats_from_result(request, result)
    else:
        # Old path (unchanged)
        self.sdn_obj.handle_event(request_dict, 'arrival')
        self._update_stats_from_sdn_props()
```

### handle_release

```python
def handle_release(self, current_time: tuple[int, float]) -> None:
    request_dict = self.reqs_dict[current_time]

    if self._use_orchestrator:
        # New path
        request = self._requests.get(current_time)
        if request:
            self._orchestrator.handle_release(request, self._network_state)
    else:
        # Old path (unchanged)
        self.sdn_obj.handle_event(request_dict, 'release')
```

## Configuration

### Via engine_props

```python
engine_props = {
    'use_orchestrator': True,  # Enable new path
    # ... other config ...
}
```

### Via Environment Variable

```bash
USE_ORCHESTRATOR=1 python -m fusion.cli.run_sim --config myconfig.ini
```

### Via CLI Argument (future)

```bash
python -m fusion.cli.run_sim --config myconfig.ini --use-orchestrator
```

## Exit Criteria

- [ ] Feature flag added to SimulationEngine
- [ ] Legacy path unchanged when flag is False
- [ ] New path works when flag is True
- [ ] Request storage for release events
- [ ] Stats updated correctly for both paths
- [ ] `mypy --strict` passes
- [ ] `ruff check` passes
- [ ] Integration tests pass for both paths

## Next Sub-phase

After P3.3 completes, proceed to [P3.4 Stats Integration](../P3.4_stats_integration/P3.4.index.md).
