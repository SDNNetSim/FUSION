# Task ID: P3.3.a - Map SDNController Call Sites

**Sub-phase:** P3.3
**Scope:** Phase 3 - Orchestrator & Pipelines only
**Task type:** context-extraction

## Purpose

Map all locations in SimulationEngine that call SDNController to understand what needs dual-path wiring.

## Context to load before running this task

- `.claude/v5-final-docs/phase-3-orchestrator/P3.3_feature_flag_and_wiring/P3.3.shared_context_simulation_entrypoints.md`
- `fusion/core/simulation.py` (full file)

## Outputs

### 1. SDNController Access Points

Create a detailed inventory of all SDNController interactions:

```markdown
## Direct sdn_obj Usage

### __init__ (line ~XX)
- Creates: `self.sdn_obj = SDNController(engine_props)`
- Action: **Add conditional creation**

### handle_arrival (lines ~XX-XX)
- Reads: `self.sdn_obj.sdn_props` (update params)
- Calls: `self.sdn_obj.handle_event(request_dict, 'arrival')`
- Reads: `self.sdn_obj.sdn_props.was_routed`
- Reads: `self.sdn_obj.sdn_props.lightpath_id_list`
- Action: **Add conditional path**

### handle_release (lines ~XX-XX)
- Calls: `self.sdn_obj.handle_event(request_dict, 'release')`
- Reads: `self.sdn_obj.sdn_props.lightpath_status_dict`
- Action: **Add conditional path**

### update_arrival_params (lines ~XX-XX)
- Reads: `self.sdn_obj.sdn_props.*` (many fields)
- Action: **Split into two update methods**

### init_iter (lines ~XX-XX)
- Calls: `self.sdn_obj.reset()` or similar
- Action: **Add network_state reset**

### create_topology (lines ~XX-XX)
- Sets: `self.sdn_obj.sdn_props.topology = ...`
- Action: **Also create NetworkState**

## sdn_props Field Access

| Field | Used In | New Path Equivalent |
|-------|---------|---------------------|
| `was_routed` | update_arrival_params | `result.success` |
| `lightpath_id_list` | update_arrival_params, handle_release | `request.lightpath_ids` |
| `path_list` | update_arrival_params | `result.path` |
| `bandwidth_list` | update_arrival_params | `request.bandwidth_gbps` |
| `modulation_list` | update_arrival_params | `result.modulation` |
| `was_groomed` | update_arrival_params | `result.is_groomed` |
| `was_sliced` | update_arrival_params | `result.is_sliced` |
| `network_spectrum_dict` | stats update | `network_state.network_spectrum_dict` |
| `lightpath_status_dict` | stats update | `network_state.lightpath_status_dict` |
```

### 2. Categorized Changes

```markdown
## Changes by Category

### Must Keep Both Paths
- `__init__`: Conditional SDNController vs SDNOrchestrator creation
- `handle_arrival`: Conditional event routing
- `handle_release`: Conditional event routing
- `update_arrival_params`: Conditional stats update

### New Path Only
- `_update_stats_from_result`: New method for orchestrator results
- `_requests`: New dict to store Request objects
- `_network_state`: NetworkState instance
- `_orchestrator`: SDNOrchestrator instance

### Shared (Both Paths)
- `create_topology`: Both need topology
- `run`: Main loop unchanged
- `end_iter`: Stats finalization
- `stats`: SimStats object (same for both)
```

### 3. Data Flow Mapping

```markdown
## Arrival Data Flow

### Legacy Path
request_dict -> sdn_props.update_params -> sdn_obj.handle_event
                                                  |
                                                  v
                                         sdn_props populated
                                                  |
                                                  v
                                         reqs_status_dict[time] = {...}
                                                  |
                                                  v
                                         stats.iter_update()

### New Path
request_dict -> Request.from_legacy_dict -> orchestrator.handle_arrival
                                                  |
                                                  v
                                           AllocationResult
                                                  |
                                                  v
                                         _requests[time] = request
                                                  |
                                                  v
                                         stats.record_arrival()
```

### 4. Method Signature Changes

```markdown
## Method Changes Required

### __init__(self, engine_props: dict)
Add:
- `self._use_orchestrator: bool`
- `self._config: SimulationConfig | None`
- `self._network_state: NetworkState | None`
- `self._orchestrator: SDNOrchestrator | None`
- `self._requests: dict[tuple[int, float], Request]`

### handle_arrival(self, current_time: tuple[int, float])
No signature change, but internal conditional:
```python
if self._use_orchestrator:
    # New path
else:
    # Old path (existing code)
```

### handle_release(self, current_time: tuple[int, float])
No signature change, internal conditional similar to arrival.

### NEW: _update_stats_from_result(self, request, result)
```python
def _update_stats_from_result(
    self,
    request: Request,
    result: AllocationResult,
) -> None:
    """Update stats from orchestrator result."""
    ...
```
```

### 5. Risk Assessment

```markdown
## Risks and Mitigations

### Risk: Breaking Legacy Path
- **Mitigation**: All legacy code paths wrapped in `if not self._use_orchestrator`
- **Verification**: Default flag is False, existing tests must pass

### Risk: Stats Inconsistency
- **Mitigation**: Both paths call same SimStats methods or equivalent
- **Verification**: run_comparison.py validates both paths

### Risk: Request State Loss
- **Mitigation**: Store Request in _requests dict keyed by time
- **Verification**: Release events must find corresponding arrival

### Risk: NetworkState Out of Sync
- **Mitigation**: NetworkState is source of truth for new path
- **Verification**: Legacy network_spectrum_dict not used in new path
```

## Verification

After extraction, verify:
- [ ] All sdn_obj usages documented
- [ ] All sdn_props field accesses mapped
- [ ] New path equivalents identified
- [ ] Risk mitigations defined

## Next Task

After completing this mapping, proceed to `P3.3.b_design_feature_flag.md`.
