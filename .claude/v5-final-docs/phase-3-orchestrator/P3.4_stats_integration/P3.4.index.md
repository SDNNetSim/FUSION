# P3.4 Stats Integration - Index

## Sub-phase Overview

**Goal**: Integrate `StatsCollector` with SDNOrchestrator results so the new path produces equivalent statistics to the legacy path.

**Files Modified**:
- `fusion/stats/collector.py` (or `fusion/core/metrics.py`)
- `fusion/core/simulation.py`

**Dependencies**:
- P3.1-P3.3 complete
- Phase 1 complete (StatsCollector, result objects)

## Objectives

1. Design `record_arrival` method for StatsCollector
2. Map AllocationResult fields to existing stats metrics
3. Ensure both paths produce equivalent statistics
4. Support all existing stats features (blocking, utilization, etc.)

## Constraints

- **Stats parity**: Both paths must produce same metrics
- **No regressions**: Existing stats functionality preserved
- **Same formats**: Output formats identical for both paths
- All code must pass `mypy --strict` and `ruff check`

## Micro-tasks

Execute in alphabetical order:

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P3.4.a | `P3.4.a_extract_current_stats_behavior.md` | context-extraction | Document current stats behavior |
| P3.4.b | `P3.4.b_design_stats_api_extension.md` | design | Design new stats API methods |
| P3.4.c | `P3.4.c_implement_stats_integration.md` | refactor-plan | Implement stats methods |
| P3.4.d | `P3.4.d_verify_stats_parity.md` | verification-plan | Verify stats equivalence |

## Shared Context

- `P3.4.shared_context_stats_requirements.md` - Stats metrics and requirements

## Stats Flow Comparison

### Legacy Path

```
handle_arrival()
    |
    v
sdn_obj.handle_event('arrival')
    |
    v
update_arrival_params()
    |
    v
stats.iter_update(req_data, sdn_data, network_spectrum_dict)
    |
    +-- Updates blocked_requests count
    +-- Updates bandwidth_blocking
    +-- Updates hops_list, lengths_list
    +-- Updates modulations_used_dict
    +-- Updates block_reasons_dict
    +-- Updates snapshots_dict
```

### New Path

```
handle_arrival()
    |
    v
orchestrator.handle_arrival(request, network_state)
    |
    v
_update_stats_from_result(request, result)
    |
    v
stats.record_arrival(request, result, network_state)  # NEW METHOD
    |
    +-- Same metrics as legacy
    +-- Uses AllocationResult fields
    +-- Uses Request fields
    +-- Uses NetworkState for spectrum data
```

## Key Metrics to Track

| Metric | Source (Legacy) | Source (New Path) |
|--------|-----------------|-------------------|
| blocked_requests | sdn_props.was_routed | result.success |
| bandwidth_blocking | sdn_props.bandwidth_list | result.total_bandwidth_allocated_gbps |
| groomed_requests | sdn_props.was_groomed | result.is_groomed |
| sliced_requests | sdn_props.was_sliced | result.is_sliced |
| protected_requests | sdn_props.is_protected | result.is_protected |
| block_reason | sdn_props (derived) | result.block_reason |
| lightpath_ids | sdn_props.lightpath_id_list | request.lightpath_ids |
| path_hops | sdn_props.path_list | result.path (if available) |

## API Design

### New record_arrival Method

```python
class StatsCollector:
    def record_arrival(
        self,
        request: Request,
        result: AllocationResult,
        network_state: NetworkState,
    ) -> None:
        """
        Record stats from orchestrator allocation result.

        This method provides the same functionality as iter_update
        but works with Phase 1 domain objects instead of legacy
        sdn_props.
        """
        self.total_requests += 1

        if result.success:
            self._record_successful_allocation(request, result, network_state)
        else:
            self._record_blocked_request(request, result)
```

## Exit Criteria

- [ ] `record_arrival` method implemented
- [ ] All metrics tracked by both paths
- [ ] Stats output format unchanged
- [ ] Both paths produce equivalent metrics
- [ ] `mypy --strict` passes
- [ ] `ruff check` passes
- [ ] Comparison tests pass

## Next Sub-phase

After P3.4 completes, proceed to [P3.5 Run Comparison & Rollback](../P3.5_run_comparison_and_rollback/P3.5.index.md).
