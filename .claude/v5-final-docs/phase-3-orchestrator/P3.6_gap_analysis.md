# Phase 3 Gap Analysis

**Date**: 2024-12-08
**Scope**: Compare V2/V3 architecture plans and v4 decisions against v5 Phase 3 docs

## Executive Summary

This gap analysis identifies missing or incomplete specifications in the v5 Phase 3 documentation compared to the detailed orchestration rules in V3 and the v4 architecture decision records. Several key behaviors around rollback, protection integration, ML/RL wiring, and congestion handling need additional documentation.

## Gap Categories

| Category | Severity | Status |
|----------|----------|--------|
| Grooming Rollback Rules | HIGH | Incomplete |
| Protection Pipeline Integration | HIGH | Missing |
| Routing Strategy Pattern | MEDIUM | Incomplete |
| ML/RL Integration Rules | MEDIUM | Missing |
| Congestion Handler Integration | HIGH | Missing |
| NetworkState Sharing Rules | MEDIUM | Incomplete |
| Feature Flag Interactions | MEDIUM | Incomplete |
| Run Comparison Baseline | LOW | Incomplete |

---

## Gap 1: Grooming Rollback Rules (HIGH)

### V3 Specification (source)

From `ARCHITECTURE_REFACTOR_PLAN_V3.md`, grooming rollback rules:

```
When partial grooming succeeds but the new lightpath allocation fails:
1. If can_partially_serve=False: MUST rollback all groomed lightpaths
2. Rollback restores bandwidth to groomed lightpaths
3. Rollback does NOT release the groomed lightpath itself
4. The request is marked as BLOCKED with appropriate reason
5. Groomed lightpath utilization must be adjusted
```

### v5 P3 Current State

P3.2.d shows basic rollback in `_handle_failure`:
```python
if groomed_lightpaths and self.grooming:
    self.grooming.rollback(request, groomed_lightpaths, network_state)
```

### Gap

The v5 docs do not specify:
- What `GroomingPipeline.rollback()` must do internally
- How bandwidth is restored to groomed lightpaths
- How utilization stats are adjusted during rollback
- Interaction with `can_partially_serve` flag
- Edge cases (what if rollback fails?)

### Remediation

Create `P3.2.f_grooming_rollback_specification.md` with complete rollback semantics.

---

## Gap 2: Protection Pipeline Integration (HIGH)

### V3 Specification (source)

From V3 and ADR-0012, protection pipeline stages:

```
Protection Pipeline Stages:
1. FIND_WORKING_PATH - Get primary path via RoutingPipeline
2. FIND_PROTECTION_PATH - Get disjoint backup path
3. VALIDATE_DISJOINTNESS - Ensure link/node disjointness
4. ALLOCATE_WORKING_SPECTRUM - Allocate for primary
5. ALLOCATE_PROTECTION_SPECTRUM - Allocate for backup
6. VALIDATE_SNR_BOTH - Check SNR on both paths
7. COMMIT_BOTH - Atomically commit both allocations

Failure at any stage rolls back all previous allocations.
```

### v5 P3 Current State

P3.1.b mentions `ProtectionPipeline` in the pipeline set, but no detailed specification exists.

### Gap

- No `P3.X` task defines protection pipeline stages
- No specification for disjointness validation
- No atomic commit semantics documented
- No protection-specific rollback rules

### Remediation

Create `P3.2.g_protection_pipeline_integration.md` documenting protection flow through orchestrator.

---

## Gap 3: Routing Strategy Pattern (MEDIUM)

### V3 Specification (source)

From ADR-0008:

```python
class AbstractRoutingStrategy(Protocol):
    def select_paths(
        self,
        source: str,
        destination: str,
        bandwidth_gbps: int,
        network_state: NetworkState,
        constraints: RouteConstraints | None = None,
    ) -> RouteResult:
        """Select candidate paths based on strategy."""

# Concrete strategies:
- KShortestPathStrategy
- ConstrainedRoutingStrategy
- LoadBalancedStrategy
- ProtectionAwareStrategy
```

### v5 P3 Current State

P3.1.b mentions `RoutingPipeline.find_routes()` but doesn't detail strategy pattern.

### Gap

- Strategy interface not specified in v5
- No documentation of strategy selection
- No specification for constraint handling
- No protection-aware routing details

### Remediation

Add strategy pattern details to P3.1 shared context or create new file.

---

## Gap 4: ML/RL Integration Rules (MEDIUM)

### V3 Specification (source)

From V3:

```
ML Control Pattern:
- Orchestrator provides observation() method for state extraction
- Orchestrator provides action_space() for valid actions
- RL agent calls apply_action(action_id)
- Orchestrator translates action_id to pipeline parameters
- Action masking via get_valid_actions()

Observation includes:
- Network spectrum utilization
- Pending request features
- Historical blocking rates
- Current lightpath states
```

### v5 P3 Current State

Not covered in Phase 3 documentation.

### Gap

- No RL integration interface defined
- No observation extraction method
- No action space definition
- No action masking specification

### Remediation

This may be Phase 4 scope, but document the interface in P3 for forward compatibility.

---

## Gap 5: Congestion Handler Integration (HIGH)

### V3 Specification (source)

From V3:

```
Congestion Handling Flow:
1. SNR validation fails due to interference
2. Identify affected existing lightpaths
3. Recheck SNR on affected lightpaths
4. If any existing LP now fails SNR:
   a. Rollback the new allocation
   b. Do NOT record utilization for rolled-back LP
   c. Try next candidate path
5. Stats must track congestion-related blocks separately
```

### v5 P3 Current State

Not covered in Phase 3 documentation.

### Gap

- No congestion handler in pipeline set
- No specification for SNR recheck flow
- No utilization rollback on congestion
- `SNR_RECHECK_FAIL` block reason not mapped

### Remediation

Create `P3.2.h_congestion_handling_specification.md` or add to SNR pipeline docs.

---

## Gap 6: NetworkState Sharing Rules (MEDIUM)

### V3 Specification (source)

From V3:

```
NetworkState Sharing Rules:
1. Orchestrator receives NetworkState per call - NEVER stores reference
2. Pipelines receive NetworkState per call
3. NetworkState is mutable during a single request handling
4. SimulationEngine is the owner of NetworkState lifecycle
5. No pipeline may cache NetworkState across calls
6. Thread safety: single-threaded assumption for Phase 3
```

### v5 P3 Current State

P3.2 mentions "receives per call, never stores" but rules are scattered.

### Gap

- Rules not consolidated in one place
- No explicit thread safety documentation
- No guidance on what pipelines can/cannot do with state

### Remediation

Add NetworkState rules to P3.2 shared context.

---

## Gap 7: Feature Flag Interactions (MEDIUM)

### V3 Specification (source)

From V3:

```
Feature Flag Matrix:
| grooming | snr | slicing | protection | Behavior |
|----------|-----|---------|------------|----------|
| F | F | F | F | Basic routing + spectrum only |
| T | F | F | F | Grooming before routing |
| F | T | F | F | SNR validation after spectrum |
| T | T | F | F | Groom -> Route -> Spectrum -> SNR |
| T | T | T | F | Full pipeline with slicing fallback |
| * | * | * | T | Protection path required |

Invalid combinations:
- slicing=T with grooming=F (slicing requires same-path routing)
```

### v5 P3 Current State

P3.3 documents individual flags but not interactions.

### Gap

- No flag interaction matrix
- No invalid combination validation
- No documentation of flag precedence

### Remediation

Add flag interaction table to P3.3 shared context.

---

## Gap 8: Run Comparison Baseline Behavior (LOW)

### V3 Specification (source)

From V3:

```
Equivalence Definition:
- "Equivalent" means statistically indistinguishable
- Same seed must produce same request sequence
- Different RNG consumption patterns are acceptable
- 2% tolerance accounts for floating-point and timing differences

Non-equivalence Indicators:
- Systematic bias (always higher or lower blocking)
- Different block reason distribution shape
- Path length/hop variance > 5%
```

### v5 P3 Current State

P3.5 documents 2% tolerance but limited detail on non-equivalence indicators.

### Gap

- No systematic bias detection documented
- No secondary metric thresholds
- No guidance on "shape" comparison for distributions

### Remediation

Expand P3.5 shared context with detailed comparison rules.

---

## Summary of Required New Documents

| Document | Priority | Content |
|----------|----------|---------|
| P3.2.f_grooming_rollback_specification.md | HIGH | Complete rollback semantics |
| P3.2.g_protection_pipeline_integration.md | HIGH | Protection stages and atomicity |
| P3.2.h_congestion_handling_specification.md | HIGH | SNR recheck and utilization rollback |
| P3.1.e_routing_strategy_pattern.md | MEDIUM | Strategy interface and selection |
| P3.3.e_feature_flag_interactions.md | MEDIUM | Flag matrix and validation |
| P3.X_ml_rl_integration_interface.md | MEDIUM | RL observation/action interface |

## Updates to Existing Documents

| Document | Update |
|----------|--------|
| P3.2.shared_context_orchestrator_responsibilities.md | Add NetworkState rules |
| P3.5.shared_context_run_comparison_expectations.md | Add non-equivalence indicators |
| P3.1.shared_context_pipeline_selection_rules.md | Add strategy pattern reference |

---

## Next Steps

1. Create HIGH priority documents first (rollback, protection, congestion)
2. Update existing shared contexts
3. Create MEDIUM priority documents
4. Review for completeness against V3
