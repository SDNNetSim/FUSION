# Task ID: P3.5.b - Design Rollback Plan

**Sub-phase:** P3.5
**Scope:** Phase 3 - Orchestrator & Pipelines only
**Task type:** design

## Purpose

Design the rollback procedures for quickly reverting to the legacy path if issues are discovered with the new orchestrator.

## Context to load before running this task

- `.claude/v5-final-docs/phase-3-orchestrator/P3.5_run_comparison_and_rollback/P3.5.shared_context_run_comparison_expectations.md`
- `.claude/v5-final-docs/phase-3-orchestrator/P3.3_feature_flag_and_wiring/P3.3.b_design_feature_flag.md`

## Outputs

### 1. Rollback Decision Tree

```
Issue Detected
    |
    +-- Is it blocking production?
    |       |
    |       +-- YES --> Immediate Rollback (Level 1)
    |       |
    |       +-- NO --> Continue to assessment
    |
    +-- Is it a correctness issue?
    |       |
    |       +-- YES (stats wrong) --> Scheduled Rollback (Level 2)
    |       |
    |       +-- NO (perf issue) --> Monitor & Investigate
    |
    +-- Can it be fixed quickly?
            |
            +-- YES (< 1 hour) --> Fix Forward
            |
            +-- NO --> Scheduled Rollback (Level 2)
```

### 2. Rollback Levels

#### Level 1: Immediate Rollback (Environment Variable)

**When to use**: Production crash, critical bug, data corruption

**Time to effect**: Immediate (restart required)

```bash
# Set environment variable
export USE_ORCHESTRATOR=0

# Restart simulation process
# (Implementation-dependent)
```

**Advantages**:
- No code changes
- No deployment
- Immediate effect
- Easy to verify

**Disadvantages**:
- Requires process restart
- Affects all simulations on system

#### Level 2: Scheduled Rollback (Configuration)

**When to use**: Stats deviation, performance degradation

**Time to effect**: Next simulation start

```ini
# In config file (e.g., config.ini)
[simulation]
use_orchestrator = false
```

**Advantages**:
- Targeted to specific configs
- No process restart needed for new runs
- Auditable change

**Disadvantages**:
- Requires config file access
- Only affects new simulations

#### Level 3: Code Rollback (Git)

**When to use**: Fundamental design issue, needs investigation

**Time to effect**: After deployment

```bash
# Revert Phase 3 commits (if needed)
git revert <phase3-commit-hash>

# Or temporarily disable orchestrator code
# (Not recommended - use feature flag instead)
```

**Advantages**:
- Complete removal of new code
- Full return to previous state

**Disadvantages**:
- Requires deployment
- Loses ability to test fixes
- Harder to re-enable

### 3. Rollback Procedures

#### Procedure 1: Emergency Rollback

```markdown
## Emergency Rollback Procedure

### Trigger
- Simulation crash when USE_ORCHESTRATOR=1
- Severe stats deviation (>10%)
- Data corruption suspected

### Steps
1. **Confirm issue is orchestrator-related**
   ```bash
   # Try with legacy path
   USE_ORCHESTRATOR=0 python -m fusion.cli.run_sim --config test.ini
   ```

2. **If legacy path works, rollback**
   ```bash
   # For all running simulations
   export USE_ORCHESTRATOR=0

   # Restart affected processes
   systemctl restart fusion-sim  # or equivalent
   ```

3. **Verify rollback**
   ```bash
   # Check logs for "using legacy SDNController path"
   grep "SDNController" /var/log/fusion/simulation.log
   ```

4. **Document issue**
   - Create GitHub issue with error details
   - Include stack trace
   - Include config that triggered issue

5. **Notify team**
   - Post in #fusion-dev channel
   - Tag @phase3-owners

### Recovery Time Objective
- Detection to rollback: < 5 minutes
- Verification: < 2 minutes
```

#### Procedure 2: Planned Rollback

```markdown
## Planned Rollback Procedure

### Trigger
- Stats deviation 2-10%
- Performance degradation
- Investigation needed

### Steps
1. **Assess impact**
   - Which configs affected?
   - What is the deviation?
   - Is it consistent?

2. **Update configuration**
   ```bash
   # Edit affected config files
   vim /etc/fusion/production.ini
   # Set: use_orchestrator = false
   ```

3. **Communicate change**
   - Update documentation
   - Notify users
   - Log in change log

4. **Monitor legacy path**
   - Verify blocking rates return to expected
   - Check for other issues

5. **Create investigation ticket**
   - Document deviation
   - Assign to Phase 3 team
   - Set priority based on impact
```

### 4. Verification Checklist

After rollback, verify:

```markdown
## Rollback Verification Checklist

### Immediate Checks
- [ ] Simulations start successfully
- [ ] No error logs from orchestrator
- [ ] Blocking rates return to expected

### 24-Hour Checks
- [ ] Stats are consistent with historical data
- [ ] No user reports of issues
- [ ] Performance metrics normal

### Before Re-enabling
- [ ] Root cause identified
- [ ] Fix implemented and tested
- [ ] Comparison tests pass
- [ ] Team approval obtained
```

### 5. Communication Template

```markdown
## Rollback Notification Template

**Subject**: [FUSION] Phase 3 Orchestrator Rollback - {DATE}

**Status**: ROLLED BACK / INVESTIGATING / RESOLVED

**Summary**:
The Phase 3 orchestrator has been rolled back due to {ISSUE}.

**Impact**:
- Affected configs: {LIST}
- Duration: {TIME} to {TIME}
- Simulations affected: {COUNT}

**Root Cause**:
{DESCRIPTION - if known}

**Resolution**:
{STEPS TAKEN}

**Next Steps**:
1. {ACTION 1}
2. {ACTION 2}
3. {ACTION 3}

**Contact**:
For questions, contact @phase3-team in #fusion-dev
```

### 6. Re-enablement Procedure

```markdown
## Re-enablement Procedure

### Prerequisites
- [ ] Root cause fixed
- [ ] Unit tests pass
- [ ] Comparison tests pass
- [ ] Code review approved
- [ ] Team sign-off

### Steps
1. **Deploy fix** (if code change needed)

2. **Test in staging**
   ```bash
   USE_ORCHESTRATOR=1 python tests/run_comparison_p3.py --requests 10000
   ```

3. **Enable for single config**
   ```ini
   # test-config.ini
   use_orchestrator = true
   ```

4. **Monitor for 24 hours**

5. **Gradual rollout**
   - Enable for non-critical configs
   - Monitor for 48 hours
   - Enable for all configs

6. **Document and close**
   - Update incident report
   - Close related tickets
   - Update runbook if needed
```

## Verification

After design, verify:
- [ ] All rollback levels documented
- [ ] Procedures clear and actionable
- [ ] Verification steps included
- [ ] Communication templates ready

## Next Task

After completing this design, proceed to `P3.5.c_execute_comparison_verification.md`.
