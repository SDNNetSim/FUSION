# P3.5 Run Comparison & Rollback Verification - Index

## Sub-phase Overview

**Goal**: Verify the new orchestrator path produces equivalent results to the legacy path using `run_comparison.py`, and document rollback procedures.

**Files Modified**:
- `tests/run_comparison.py` (minor modifications if needed)

**Dependencies**:
- P3.1-P3.4 complete
- Both simulation paths functional

## Objectives

1. Define comparison procedure for validating both paths
2. Establish acceptance criteria (tolerance levels)
3. Create rollback plan for quick recovery if issues arise
4. Document operational procedures for Phase 3

## Constraints

- **2% tolerance**: Blocking probability within 2% absolute difference
- **Same seeds**: Both paths must use identical random seeds
- **Non-destructive**: Rollback must not require code changes
- **Quick rollback**: Feature flag provides immediate fallback

## Micro-tasks

Execute in alphabetical order:

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P3.5.a | `P3.5.a_design_comparison_procedure.md` | design | Design comparison process |
| P3.5.b | `P3.5.b_design_rollback_plan.md` | design | Design rollback procedures |
| P3.5.c | `P3.5.c_execute_comparison_verification.md` | verification-plan | Execute and verify |

## Shared Context

- `P3.5.shared_context_run_comparison_expectations.md` - Expected behavior and tolerances

## Comparison Process

```
run_comparison.py (or verification script)
    |
    v
[1. Load Configuration]
    |-- Read config file
    |-- Set common seed
    |-- Set num_requests, max_iterations
    |
    v
[2. Run Legacy Path]
    |-- use_orchestrator = False
    |-- Execute simulation
    |-- Collect stats
    |
    v
[3. Run New Path]
    |-- use_orchestrator = True
    |-- Execute simulation (same seed)
    |-- Collect stats
    |
    v
[4. Compare Results]
    |-- Compare blocking probability
    |-- Compare block reasons
    |-- Compare resource usage
    |
    v
[5. Report]
    |-- PASS if within tolerance
    |-- FAIL if exceeds tolerance
    |-- Details on deviations
```

## Acceptance Criteria

| Metric | Tolerance | Required? |
|--------|-----------|-----------|
| Blocking probability | < 2% absolute | Yes |
| Bit-rate blocking | < 2% absolute | Yes |
| Block reason distribution | Similar shape | No |
| Modulation distribution | Similar shape | No |
| Path length average | < 5% relative | No |

## Rollback Strategy

```
Production Issue Detected
    |
    v
[Immediate: Feature Flag]
    |-- Set USE_ORCHESTRATOR=0 in environment
    |-- OR: Set use_orchestrator=False in config
    |-- Restart simulation
    |
    v
[Result: Legacy Path Active]
    |-- No code changes required
    |-- No deployment required
    |-- Immediate effect
```

## Commands

### Run Comparison

```bash
# Default comparison
python tests/run_comparison.py

# With orchestrator enabled
USE_ORCHESTRATOR=1 python tests/run_comparison.py

# Compare specific config
python tests/run_comparison.py --config configs/test.ini --seed 42
```

### Rollback Commands

```bash
# Environment variable rollback
export USE_ORCHESTRATOR=0
python -m fusion.cli.run_sim --config myconfig.ini

# Config file rollback
# Edit config.ini: use_orchestrator = false
```

## Exit Criteria

- [ ] Comparison procedure documented
- [ ] Rollback plan documented
- [ ] Both paths pass comparison within tolerance
- [ ] Operational guide written
- [ ] Phase 3 complete

## Phase 3 Completion

After P3.5 completes, Phase 3 is finished. Deliverables:

1. **PipelineFactory** (`fusion/core/pipeline_factory.py`)
   - Creates pipelines based on configuration
   - PipelineSet container for all pipelines

2. **SDNOrchestrator** (`fusion/core/orchestrator.py`)
   - Thin coordination layer
   - Routes requests through pipelines

3. **Feature Flag Integration** (`fusion/core/simulation.py`)
   - `use_orchestrator` flag
   - Dual-path support

4. **Stats Integration** (`fusion/core/metrics.py`)
   - `record_arrival` method
   - Equivalent metrics for both paths

5. **Verification** (`tests/run_comparison.py`)
   - Automated comparison
   - Tolerance validation
