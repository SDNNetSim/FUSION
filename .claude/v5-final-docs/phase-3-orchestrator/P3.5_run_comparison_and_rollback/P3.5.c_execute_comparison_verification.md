# Task ID: P3.5.c - Execute Comparison Verification

**Sub-phase:** P3.5
**Scope:** Phase 3 - Orchestrator & Pipelines only
**Task type:** verification-plan

## Purpose

Execute the comparison tests and verify Phase 3 is complete.

## Context to load before running this task

- `.claude/v5-final-docs/phase-3-orchestrator/P3.5_run_comparison_and_rollback/P3.5.a_design_comparison_procedure.md`
- `.claude/v5-final-docs/phase-3-orchestrator/P3.5_run_comparison_and_rollback/P3.5.b_design_rollback_plan.md`

## Outputs

### 1. Verification Commands

```bash
# ============================================================
# Phase 3 Verification Commands
# ============================================================

# 1. Code Quality Checks
echo "=== Code Quality ==="
mypy fusion/core/orchestrator.py fusion/core/pipeline_factory.py --strict
ruff check fusion/core/orchestrator.py fusion/core/pipeline_factory.py

# 2. Unit Tests
echo "=== Unit Tests ==="
pytest fusion/tests/core/test_orchestrator.py -v
pytest fusion/tests/core/test_pipeline_factory.py -v
pytest fusion/tests/core/test_simulation_feature_flag.py -v

# 3. Quick Comparison (1000 requests)
echo "=== Quick Comparison ==="
python tests/run_comparison_p3.py --requests 1000 --iterations 1 --seed 42

# 4. Standard Comparison (10000 requests)
echo "=== Standard Comparison ==="
python tests/run_comparison_p3.py --requests 10000 --iterations 3 --seed 42

# 5. Integration Tests
echo "=== Integration Tests ==="
pytest tests/integration/ -v

# 6. Legacy Path Verification
echo "=== Legacy Path Verification ==="
USE_ORCHESTRATOR=0 pytest tests/integration/ -v

# 7. New Path Verification
echo "=== New Path Verification ==="
USE_ORCHESTRATOR=1 pytest tests/integration/ -v
```

### 2. Expected Results

```markdown
## Expected Verification Results

### Code Quality
```
mypy: Success: no issues found
ruff: All checks passed!
```

### Unit Tests
```
test_orchestrator.py::TestSDNOrchestratorInit::test_init_stores_config PASSED
test_orchestrator.py::TestHandleArrivalBasicPath::test_returns_success... PASSED
test_pipeline_factory.py::TestPipelineSet::test_create_with_required_only PASSED
...
23 passed in 5.32s
```

### Comparison Test
```
============================================================
PHASE 3 COMPARISON REPORT
============================================================

Legacy blocking probability: 0.0523
New blocking probability:    0.0531
Absolute difference:         0.0008

------------------------------------------------------------
RESULT: PASS - Within tolerance
------------------------------------------------------------
```
```

### 3. Troubleshooting Guide

```markdown
## Troubleshooting Guide

### Issue: Unit Tests Fail

**Symptom**: pytest fails on test_orchestrator.py

**Debug Steps**:
1. Check import errors
   ```bash
   python -c "from fusion.core.orchestrator import SDNOrchestrator"
   ```

2. Check dependencies
   ```bash
   pip list | grep fusion
   ```

3. Run single test with verbose output
   ```bash
   pytest fusion/tests/core/test_orchestrator.py::TestSDNOrchestratorInit -vvv
   ```

### Issue: Comparison Fails

**Symptom**: Blocking probability difference > 2%

**Debug Steps**:
1. Enable debug logging
   ```bash
   FUSION_LOG_LEVEL=DEBUG python tests/run_comparison_p3.py
   ```

2. Check with smaller request count
   ```bash
   python tests/run_comparison_p3.py --requests 100 --iterations 1
   ```

3. Compare block reasons
   - Are they distributed similarly?
   - Is one path blocking on a specific reason?

4. Check route results
   - Add logging to routing pipeline
   - Compare path selections

### Issue: Crashes on New Path

**Symptom**: Simulation crashes with USE_ORCHESTRATOR=1

**Debug Steps**:
1. Get stack trace
   ```bash
   USE_ORCHESTRATOR=1 python -m fusion.cli.run_sim --config test.ini 2>&1 | tee crash.log
   ```

2. Check orchestrator line count
   ```bash
   wc -l fusion/core/orchestrator.py
   # Should be < 200
   ```

3. Verify NetworkState initialization
   ```python
   from fusion.domain.network_state import NetworkState
   # Check for import errors
   ```

4. Test each pipeline individually
   ```python
   from fusion.core.pipeline_factory import PipelineFactory
   config = ...
   pipelines = PipelineFactory.create_pipeline_set(config)
   print(pipelines)
   ```
```

### 4. Final Verification Checklist

```markdown
## Phase 3 Final Verification Checklist

### Code Quality
- [ ] `mypy --strict` passes on all Phase 3 files
- [ ] `ruff check` passes on all Phase 3 files
- [ ] orchestrator.py < 200 lines
- [ ] Each method < 50 lines

### Unit Tests
- [ ] test_pipeline_factory.py passes
- [ ] test_orchestrator.py passes
- [ ] test_simulation_feature_flag.py passes
- [ ] test_stats_new_path.py passes

### Integration Tests
- [ ] Legacy path (USE_ORCHESTRATOR=0) passes all tests
- [ ] New path (USE_ORCHESTRATOR=1) passes all tests

### Comparison Tests
- [ ] Quick comparison (1000 req) passes
- [ ] Standard comparison (10000 req) passes
- [ ] Blocking probability difference < 2%

### Documentation
- [ ] All P3 docs complete
- [ ] Rollback procedures documented
- [ ] Operational guide written

### Sign-off
- [ ] Developer self-review complete
- [ ] Code review approved
- [ ] Phase 3 lead approval
```

### 5. Phase 3 Completion Report

```markdown
## Phase 3 Completion Report

**Date**: ___________
**Author**: ___________

### Summary

Phase 3 introduces the SDNOrchestrator and PipelineFactory, providing a
clean separation between algorithm logic (in pipelines) and coordination
logic (in orchestrator).

### Files Created

| File | Lines | Purpose |
|------|-------|---------|
| fusion/core/orchestrator.py | ~195 | SDNOrchestrator class |
| fusion/core/pipeline_factory.py | ~120 | PipelineFactory, PipelineSet |
| fusion/pipelines/__init__.py | ~10 | Package init |

### Files Modified

| File | Changes |
|------|---------|
| fusion/core/simulation.py | Feature flag, dual-path wiring |
| fusion/core/metrics.py | record_arrival method |

### Test Results

| Test Suite | Result |
|------------|--------|
| Unit tests | PASS |
| Integration tests | PASS |
| Comparison tests | PASS |
| Code quality | PASS |

### Comparison Results

| Metric | Legacy | New | Difference |
|--------|--------|-----|------------|
| Blocking | 5.23% | 5.31% | 0.08% |

### Rollback Readiness

- Feature flag: READY
- Procedures: DOCUMENTED
- Team trained: YES/NO

### Recommendations

1. Keep USE_ORCHESTRATOR=0 as default initially
2. Gradually enable for non-critical configs
3. Monitor stats for first week
4. Plan Phase 4 kickoff

### Approval

- [ ] Phase 3 Lead: ___________
- [ ] Project Lead: ___________
- [ ] QA Sign-off: ___________
```

## Exit Criteria

Phase 3 is complete when:

- [ ] All code quality checks pass
- [ ] All unit tests pass
- [ ] All integration tests pass (both paths)
- [ ] Comparison tests within 2% tolerance
- [ ] Documentation complete
- [ ] Rollback procedures documented
- [ ] Team sign-off obtained

## Phase 3 Complete

After verification passes, Phase 3 is complete. The orchestrator is ready
for gradual rollout using the feature flag.

### Next Phase

Phase 4 will focus on:
- Replacing legacy implementations with clean pipelines
- Removing legacy adapters
- RL/ML integration with orchestrator
