# P2.3 Pipeline Protocols - Index

## Sub-phase Overview

**Goal**: Define type-safe protocol interfaces for all pipeline components (Routing, Spectrum, Grooming, SNR, Slicing).

**Output**: `fusion/interfaces/pipelines.py`

**Dependencies**:
- P2.1 and P2.2 complete (NetworkState with full API)
- Phase 1 complete (all domain and result objects)

## Objectives

1. Create `fusion/interfaces/` package
2. Define `typing.Protocol` classes for each pipeline:
   - `RoutingPipeline` - Find candidate routes
   - `SpectrumPipeline` - Find available spectrum
   - `GroomingPipeline` - Groom requests onto existing lightpaths
   - `SNRPipeline` - Validate signal quality
   - `SlicingPipeline` - Slice requests across multiple lightpaths
3. Ensure protocols are type-only (no runtime behavior in Phase 2)
4. Pass `mypy --strict` without requiring runtime imports

## Constraints

- **Protocols are pure type definitions** - No implementations in Phase 2
- **No circular imports** - Use `TYPE_CHECKING` guards
- **No heavy imports** - Protocols must be lightweight
- **Compatible with legacy** - Signatures should wrap legacy functions
- All code must pass `mypy --strict` and `ruff check`

## Micro-tasks

Execute in alphabetical order:

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P2.3.a | `P2.3.a_extract_pipeline_signatures.md` | context-extraction | Extract current pipeline entry point signatures |
| P2.3.b | `P2.3.b_design_routing_protocol.md` | design | Design RoutingPipeline protocol |
| P2.3.c | `P2.3.c_design_spectrum_protocol.md` | design | Design SpectrumPipeline protocol |
| P2.3.d | `P2.3.d_design_grooming_snr_slicing_protocols.md` | design | Design remaining protocols |
| P2.3.e | `P2.3.e_implement_all_protocols.md` | refactor-plan | Implement all protocol definitions |
| P2.3.f | `P2.3.f_verify_protocols.md` | verification-plan | mypy checks and mock implementations |

## Shared Context

- `P2.3.shared_context_existing_entrypoints.md` - Summary of legacy pipeline entry points

## Protocol Overview

### RoutingPipeline
```python
class RoutingPipeline(Protocol):
    def find_routes(
        self,
        source: str,
        destination: str,
        bandwidth_gbps: int,
        network_state: NetworkState,
        *,
        forced_path: list[str] | None = None,
    ) -> RouteResult: ...
```

### SpectrumPipeline
```python
class SpectrumPipeline(Protocol):
    def find_spectrum(
        self,
        path: list[str],
        modulation: str,
        bandwidth_gbps: int,
        network_state: NetworkState,
    ) -> SpectrumResult: ...

    def find_protected_spectrum(
        self,
        primary_path: list[str],
        backup_path: list[str],
        modulation: str,
        bandwidth_gbps: int,
        network_state: NetworkState,
    ) -> SpectrumResult: ...
```

### GroomingPipeline
```python
class GroomingPipeline(Protocol):
    def try_groom(
        self,
        request: Request,
        network_state: NetworkState,
    ) -> GroomingResult: ...

    def rollback_groom(
        self,
        request: Request,
        lightpath_ids: list[int],
        network_state: NetworkState,
    ) -> None: ...
```

### SNRPipeline
```python
class SNRPipeline(Protocol):
    def validate(
        self,
        lightpath: Lightpath,
        network_state: NetworkState,
    ) -> SNRResult: ...
```

### SlicingPipeline
```python
class SlicingPipeline(Protocol):
    def try_slice(
        self,
        request: Request,
        path: list[str],
        modulation: str,
        bandwidth_gbps: int,
        network_state: NetworkState,
    ) -> SlicingResult: ...
```

## File Structure

```
fusion/
└── interfaces/
    ├── __init__.py       # Public exports
    └── pipelines.py      # All protocol definitions
```

## Design Principles

| Principle | Implementation |
|-----------|----------------|
| Type-only | Protocols use `typing.Protocol`, no runtime behavior |
| Lightweight imports | Only import types under `TYPE_CHECKING` |
| Consistent signatures | All pipelines receive `NetworkState` as parameter |
| Result objects | All return Phase 1 result types |
| No state storage | Pipelines don't store NetworkState as attribute |

## Exit Criteria

- [ ] `fusion/interfaces/` package created
- [ ] All five protocols defined with complete signatures
- [ ] All protocols documented with docstrings
- [ ] `mypy fusion/interfaces/ --strict` passes
- [ ] `ruff check fusion/interfaces/` passes
- [ ] No runtime imports of heavy modules
- [ ] Mock implementations verify protocol correctness

## Next Sub-phase

After P2.3 completes, proceed to [P2.4 Legacy Adapters](../P2.4_legacy_adapters/P2.4.index.md).
