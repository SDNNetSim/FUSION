# P2.2 NetworkState Write Methods + Legacy Compat - Index

## Sub-phase Overview

**Goal**: Add state mutation capabilities to `NetworkState` and create temporary legacy compatibility properties for migration.

**Output**: Extended `fusion/domain/network_state.py`

**Dependencies**:
- P2.1 complete (NetworkState with read methods exists)
- Phase 1 complete (Lightpath class available)

## Objectives

1. Implement write methods on `NetworkState`:
   - `create_lightpath()` - Create and register a new lightpath
   - `release_lightpath()` - Remove lightpath and free spectrum

2. Implement internal helpers:
   - `_allocate_spectrum_on_path()` - Allocate spectrum along all path links
   - `_release_spectrum_on_path()` - Release spectrum along all path links

3. Define legacy compatibility properties (temporary shims):
   - `network_spectrum_dict` - Returns legacy format for existing code
   - `lightpath_status_dict` - Returns legacy format for existing code

4. Establish removal markers and migration checklist

## Constraints

- Write methods must use Phase 1 `Lightpath` class
- Legacy properties must match exact structure of `sdn_props` equivalents
- No changes to code outside `fusion/domain/`
- All methods must pass `mypy --strict` and `ruff check`
- Legacy properties are **temporary** - marked for Phase 5 removal

## Micro-tasks

Execute in alphabetical order:

| Task ID | File | Type | Description |
|---------|------|------|-------------|
| P2.2.a | `P2.2.a_map_legacy_structures.md` | context-extraction | Field-by-field mapping of legacy structures |
| P2.2.b | `P2.2.b_design_write_methods.md` | design | Design create/release lightpath API |
| P2.2.c | `P2.2.c_design_legacy_compat_properties.md` | design | Design legacy property specifications |
| P2.2.d | `P2.2.d_implement_write_methods.md` | refactor-plan | Implement write methods |
| P2.2.e | `P2.2.e_implement_legacy_properties.md` | refactor-plan | Implement legacy properties |
| P2.2.f | `P2.2.f_verify_write_methods.md` | verification-plan | Round-trip tests and verification |

## Shared Context

- `P2.2.shared_context_lightpath_spectrum_shapes.md` - Exact structures of legacy data shapes

## Key Methods Added

### Write Methods
```python
class NetworkState:
    # ... P2.1 methods ...

    def create_lightpath(
        self,
        path: list[str],
        start_slot: int,
        end_slot: int,
        core: int,
        band: str,
        modulation: str,
        bandwidth_gbps: int,
        path_weight_km: float,
        guard_slots: int = 0,
        backup_path: list[str] | None = None,
        backup_start_slot: int | None = None,
        backup_end_slot: int | None = None,
        backup_core: int | None = None,
        backup_band: str | None = None,
    ) -> Lightpath:
        """Create and register a new lightpath, allocating spectrum."""

    def release_lightpath(self, lightpath_id: int) -> bool:
        """Release a lightpath and free its spectrum."""
```

### Legacy Compatibility Properties
```python
class NetworkState:
    @property
    def network_spectrum_dict(self) -> dict[tuple[str, str], dict[str, Any]]:
        """
        Legacy compatibility: Returns spectrum state in sdn_props format.

        WARNING: This property is a TEMPORARY MIGRATION SHIM.
        It will be removed in Phase 5.

        Returns format matching sdn_props.network_spectrum_dict:
        {
            (node1, node2): {
                "cores_matrix": {band: np.ndarray, ...},
                "usage_count": int,
                "throughput": float,
                "link_num": int,
                ...
            }
        }
        """

    @property
    def lightpath_status_dict(self) -> dict[tuple[str, str], dict[int, dict[str, Any]]]:
        """
        Legacy compatibility: Returns lightpath state in sdn_props format.

        WARNING: This property is a TEMPORARY MIGRATION SHIM.
        It will be removed in Phase 5.

        Returns format matching sdn_props.lightpath_status_dict:
        {
            (src, dst): {  # Sorted tuple key
                lightpath_id: {
                    "path": list[str],
                    "lightpath_bandwidth": float,
                    "remaining_bandwidth": float,
                    ...
                }
            }
        }
        """
```

## Legacy Property Removal Markers

All legacy properties must include:

```python
# LEGACY_COMPAT: Phase 5 Removal Checklist
# Before removing this property, verify:
# [ ] All spectrum reads use NetworkState.is_spectrum_available() or get_link_spectrum()
# [ ] All spectrum writes use NetworkState.create_lightpath() / release_lightpath()
# [ ] No direct numpy array access outside NetworkState
# [ ] run_comparison.py passes without this property
# [ ] grep 'network_spectrum_dict' returns only this definition
```

## Exit Criteria

- [ ] `create_lightpath()` creates Lightpath and allocates spectrum correctly
- [ ] `release_lightpath()` frees spectrum and removes from registry
- [ ] Guard bands handled correctly in allocation/release
- [ ] Protected lightpaths (backup path) handled correctly
- [ ] `network_spectrum_dict` matches `sdn_props` format exactly
- [ ] `lightpath_status_dict` matches `sdn_props` format exactly
- [ ] Round-trip tests pass: create -> legacy view -> verify structure
- [ ] Unit tests achieve 90%+ coverage
- [ ] `mypy --strict` passes
- [ ] `ruff check` passes

## Next Sub-phase

After P2.2 completes, proceed to [P2.3 Pipeline Protocols](../P2.3_pipeline_protocols/P2.3.index.md).
