# Task ID: P2.1.a - Context Extraction: Current State Management

**Sub-phase:** P2.1
**Scope:** Phase 2 - State Management only
**Task type:** context-extraction

## Purpose

Extract and document how the current FUSION codebase manages network state, specifically focusing on `sdn_props` state containers and their structure. This provides the foundation for designing `NetworkState`.

## Context to load before running this task

- `.claude/v5-final-docs/phase-2-state-management/P2.1_network_state_core/P2.1.shared_context_legacy_state_sources.md`
- `fusion/core/properties.py` (lines 300-450 for SDNProps)
- `fusion/core/simulation.py` (lines 550-620 for initialization)

## Outputs

Produce a summary document (in your response, not a file) containing:

### 1. SDNProps State Fields

Document each state-related field in `SDNProps`:

| Field Name | Type | Purpose | Mutated By |
|------------|------|---------|------------|
| `network_spectrum_dict` | `dict[tuple, dict]` | Per-link spectrum state | spectrum_assignment, sdn_controller |
| `lightpath_status_dict` | `dict[tuple, dict]` | Active lightpaths by endpoint | spectrum_assignment, grooming |
| `current_lightpath_id` | `int` | Next lightpath ID counter | sdn_controller |
| ... | ... | ... | ... |

### 2. Initialization Sequence

Document the initialization flow:
1. Where topology is loaded
2. Where spectrum arrays are created
3. Default values and shapes
4. Configuration parameters that affect initialization

### 3. Mutation Points

Identify all locations where state is mutated:
- File, function, line number
- What state is changed
- Under what conditions

### 4. Access Patterns

Document common read patterns:
- How spectrum availability is checked
- How lightpaths are looked up
- How link information is retrieved

### 5. Invariants

Identify invariants that must be maintained:
- Spectrum slot values (0, positive, negative meanings)
- Bidirectional link consistency
- Lightpath ID uniqueness
- Key format consistency (sorted tuples)

## Execution Notes

This is a **read-only analysis task**. Do not modify any code.

Focus on understanding:
1. The exact structure of dictionaries used
2. How values are initialized
3. Where and how values change during simulation
4. What constraints exist on the data

The output of this task informs the design decisions in P2.1.b and P2.1.c.

## Verification

After extracting context, verify by answering:
- [ ] Can you describe the exact shape of `network_spectrum_dict` values?
- [ ] Can you list all places where `lightpath_status_dict` is modified?
- [ ] Can you explain how spectrum allocation marks slots?
- [ ] Can you explain how guard bands are represented?

## Next Task

After completing this context extraction, proceed to `P2.1.b_design_link_spectrum.md`.
