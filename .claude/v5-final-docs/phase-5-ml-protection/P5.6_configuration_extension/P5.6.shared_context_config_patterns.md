# P5.6 Shared Context: Configuration Patterns

**Sub-phase:** P5.6
**Scope:** Configuration Extension

---

## Overview

This document captures the configuration patterns used in FUSION and how Phase 5 configuration will integrate.

---

## Current Configuration Architecture

### Configuration Flow

```
config.ini (file)
    │
    ▼
ConfigParser (stdlib)
    │
    ▼
SimulationConfig (dataclass)
    │
    ├── CLI parameters override
    │
    └── Validation
    │
    ▼
Used by Orchestrator, Pipelines, etc.
```

### Current INI Structure

```ini
[simulation]
name = my_experiment
seed = 42
num_requests = 10000

[network]
topology = NSFNet
num_slots = 320
slot_width = 12.5

[traffic]
arrival_rate = 50
holding_time = 10
bandwidth_min = 25
bandwidth_max = 400

[routing]
algorithm = k_shortest_path
k = 5

[spectrum]
assignment = first_fit
```

---

## Configuration Schema Pattern

### Schema Definition (from fusion/configs/schema.py)

```python
# Current schema pattern
CONFIG_SCHEMA = {
    "simulation": {
        "name": {"type": str, "default": "experiment"},
        "seed": {"type": int, "default": 42},
        "num_requests": {"type": int, "default": 10000},
    },
    "network": {
        "topology": {"type": str, "default": "NSFNet"},
        "num_slots": {"type": int, "default": 320},
    },
    # ... other sections
}
```

### Section Registration

```python
def register_section(name: str, schema: dict) -> None:
    """Register a new config section."""
    CONFIG_SCHEMA[name] = schema
```

---

## Phase 5 Configuration Sections

### [policy] Section

```ini
[policy]
type = first_feasible           ; Policy type identifier
model_path =                    ; Path to ML model file
device = cpu                    ; Inference device
fallback_type = first_feasible  ; Fallback for ML errors
k_paths = 5                     ; Expected number of paths
```

### [protection] Section

```ini
[protection]
enabled = false                 ; Enable 1+1 protection
disjointness = link             ; link or node
switchover_time_ms = 50         ; Switchover latency
revert_after_repair = false     ; Revert to primary after repair
guard_band_slots = 1            ; Guard band for spectrum
```

### [heuristic] Section

```ini
[heuristic]
load_balance_alpha = 0.5        ; Alpha for LoadBalancedPolicy
random_seed = 42                ; Seed for RandomFeasiblePolicy
congestion_threshold = 0.8      ; Threshold for congestion avoidance
```

---

## CLI Parameter Pattern

### Current CLI Pattern

```python
# In fusion/cli/parameters/
@click.option("--seed", type=int, help="Random seed")
@click.option("--num-requests", type=int, help="Number of requests")
def run_sim(seed, num_requests, ...):
    config = load_config(config_file)
    if seed is not None:
        config.seed = seed
    if num_requests is not None:
        config.num_requests = num_requests
```

### Phase 5 CLI Parameters

```python
# Policy parameters
@click.option("--policy", type=str, help="Policy type")
@click.option("--policy-model", type=str, help="Path to ML model")
@click.option("--policy-device", type=str, help="Inference device")

# Protection parameters
@click.option("--protection/--no-protection", default=None, help="Enable protection")
@click.option("--disjointness", type=click.Choice(["link", "node"]))
@click.option("--switchover-ms", type=float, help="Switchover time")
```

---

## SimulationConfig Extension

### Current Fields

```python
@dataclass
class SimulationConfig:
    # Simulation
    name: str
    seed: int
    num_requests: int

    # Network
    topology: str
    num_slots: int

    # Traffic
    arrival_rate: float
    holding_time: float
```

### Phase 5 Fields

```python
@dataclass
class SimulationConfig:
    # ... existing fields ...

    # Policy (Phase 5)
    policy_type: str = "first_feasible"
    policy_model_path: str | None = None
    policy_device: str = "cpu"
    policy_fallback_type: str = "first_feasible"
    k_paths: int = 5

    # Protection (Phase 5)
    protection_enabled: bool = False
    protection_disjointness: str = "link"
    protection_switchover_ms: float = 50.0
    protection_revert_after_repair: bool = False
    protection_guard_band_slots: int = 1

    # Heuristic (Phase 5)
    heuristic_load_balance_alpha: float = 0.5
    heuristic_random_seed: int | None = None
    heuristic_congestion_threshold: float = 0.8
```

---

## Validation Patterns

### Type Validation

```python
def validate_policy_type(value: str) -> str:
    """Validate policy type."""
    valid_types = [
        "first_feasible",
        "shortest_feasible",
        "least_congested",
        "random",
        "load_balanced",
        "ml",
        "rl",
    ]
    if value.lower() not in valid_types:
        raise ValueError(f"Invalid policy type: {value}")
    return value.lower()

def validate_disjointness(value: str) -> str:
    """Validate disjointness type."""
    if value.lower() not in ["link", "node"]:
        raise ValueError(f"Invalid disjointness: {value}")
    return value.lower()
```

### Dependency Validation

```python
def validate_ml_policy(config: SimulationConfig) -> None:
    """Validate ML policy configuration."""
    if config.policy_type == "ml":
        if not config.policy_model_path:
            raise ValueError("ML policy requires policy_model_path")

        from pathlib import Path
        if not Path(config.policy_model_path).exists():
            raise FileNotFoundError(
                f"Model file not found: {config.policy_model_path}"
            )
```

---

## Template Updates

### default.ini

```ini
# Default configuration with Phase 5 sections

[policy]
type = first_feasible
model_path =
device = cpu
fallback_type = first_feasible

[protection]
enabled = false
disjointness = link
switchover_time_ms = 50

[heuristic]
load_balance_alpha = 0.5
random_seed =
```

### ml_experiment.ini

```ini
# ML policy experiment configuration

[policy]
type = ml
model_path = models/bc_policy.pt
device = cuda
fallback_type = shortest_feasible

[protection]
enabled = false
```

### survivability_experiment.ini

```ini
# Survivability experiment with protection

[policy]
type = shortest_feasible

[protection]
enabled = true
disjointness = link
switchover_time_ms = 50
revert_after_repair = false
```

---

## Backward Compatibility

### Missing Sections

When Phase 5 sections are missing from config file:
- Use default values
- No error or warning

```python
def load_config(path: str) -> SimulationConfig:
    parser = ConfigParser()
    parser.read(path)

    # Load existing sections...

    # Load Phase 5 sections with defaults
    config.policy_type = parser.get(
        "policy", "type", fallback="first_feasible"
    )
    config.protection_enabled = parser.getboolean(
        "protection", "enabled", fallback=False
    )
```

### CLI Override Priority

```
1. CLI parameter (highest)
2. Config file value
3. Default value (lowest)
```

---

## References

- `fusion/configs/schema.py`
- `fusion/configs/templates/`
- `fusion/cli/parameters/`
- `fusion/domain/config.py`
